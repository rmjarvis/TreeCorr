

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>treecorr.binnedcorr3 &mdash; TreeCorr 4.2.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> TreeCorr
          

          
          </a>

          
            
            
              <div class="version">
                4.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../catalog.html">Input Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation2.html">Two-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation3.html">Three-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metric.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binning.html">Binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../patches.html">Patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cov.html">Covariance Estimates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../field.html">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Using configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes from version 4.1 to 4.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html#changes-from-version-4-2-0-to-4-2-1">Changes from version 4.2.0 to 4.2.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Previous History</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TreeCorr</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>treecorr.binnedcorr3</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for treecorr.binnedcorr3</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2003-2019 by Mike Jarvis</span>
<span class="c1">#</span>
<span class="c1"># TreeCorr is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: binnedcorr3</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">coord</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_lib</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">merge_config</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">parse_metric</span><span class="p">,</span> <span class="n">metric_enum</span><span class="p">,</span> <span class="n">coord_enum</span><span class="p">,</span> <span class="n">set_omp_threads</span><span class="p">,</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">.binnedcorr2</span> <span class="kn">import</span> <span class="n">estimate_multi_cov</span>

<span class="k">class</span> <span class="nc">Namespace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="BinnedCorr3"><a class="viewcode-back" href="../../correlation3.html#treecorr.BinnedCorr3">[docs]</a><span class="k">class</span> <span class="nc">BinnedCorr3</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class stores the results of a 3-point correlation calculation, along with some</span>
<span class="sd">    ancillary data.</span>

<span class="sd">    This is a base class that is not intended to be constructed directly.  But it has a few</span>
<span class="sd">    helper functions that derived classes can use to help perform their calculations.  See</span>
<span class="sd">    the derived classes for more details:</span>

<span class="sd">    - `NNNCorrelation` handles count-count-count correlation functions</span>
<span class="sd">    - `KKKCorrelation` handles kappa-kappa-kappa correlation functions</span>
<span class="sd">    - `GGGCorrelation` handles gamma-gamma-gamma correlation functions</span>

<span class="sd">    Three-point correlations are a bit more complicated than two-point, since the data need</span>
<span class="sd">    to be binned in triangles, not just the separation between two points.  We characterize the</span>
<span class="sd">    triangles according to the following three parameters based on the three side lenghts</span>
<span class="sd">    of the triangle with d1 &gt;= d2 &gt;= d3.</span>

<span class="sd">    .. math::</span>
<span class="sd">        r &amp;= d2 \\\\</span>
<span class="sd">        u &amp;= \\frac{d3}{d2} \\\\</span>
<span class="sd">        v &amp;= \\pm \\frac{(d1 - d2)}{d3} \\\\</span>

<span class="sd">    The orientation of the triangle is specified by the sign of v.</span>
<span class="sd">    Positive v triangles have the three sides d1,d2,d3 in counter-clockwise orientation.</span>
<span class="sd">    Negative v triangles have the three sides d1,d2,d3 in clockwise orientation.</span>

<span class="sd">    .. note::</span>
<span class="sd">        We always bin the same way for positive and negative v values, and the binning</span>
<span class="sd">        specification for v should just be for the positive values.  E.g. if you specify</span>
<span class="sd">        min_v=0.2, max_v=0.6, then TreeCorr will also accumulate triangles with</span>
<span class="sd">        -0.6 &lt; v &lt; -0.2 in addition to those with 0.2 &lt; v &lt; 0.6.</span>

<span class="sd">    The constructor for all derived classes take a config dict as the first argument,</span>
<span class="sd">    since this is often how we keep track of parameters, but if you don&#39;t want to</span>
<span class="sd">    use one or if you want to change some parameters from what are in a config dict,</span>
<span class="sd">    then you can use normal kwargs, which take precedence over anything in the config dict.</span>

<span class="sd">    There are three implemented definitions for the ``metric``, which defines how to calculate</span>
<span class="sd">    the distance between two points, for three-point corretions:</span>

<span class="sd">        - &#39;Euclidean&#39; = straight line Euclidean distance between two points.  For spherical</span>
<span class="sd">          coordinates (ra,dec without r), this is the chord distance between points on the</span>
<span class="sd">          unit sphere.</span>
<span class="sd">        - &#39;Arc&#39; = the true great circle distance for spherical coordinates.</span>
<span class="sd">        - &#39;Periodic&#39; = Like Euclidean, but with periodic boundaries.</span>

<span class="sd">          .. note::</span>

<span class="sd">            The triangles for three-point correlations can become ambiguous if d1 &gt; period/2,</span>
<span class="sd">            which means the maximum d2 (max_sep) should be less than period/4.</span>
<span class="sd">            This is not enforced.</span>

<span class="sd">    So far, there is only one allowed value for the ``bin_type`` for three-point correlations.</span>

<span class="sd">        - &#39;LogRUV&#39; - The bin steps will be uniform in log(r) from log(min_sep) .. log(max_sep).</span>
<span class="sd">          The u and v values are binned linearly from min_u .. max_u and min_v .. max_v.</span>


<span class="sd">    Parameters:</span>
<span class="sd">        config (dict):      A configuration dict that can be used to pass in the below kwargs if</span>
<span class="sd">                            desired.  This dict is allowed to have addition entries in addition</span>
<span class="sd">                            to those listed below, which are ignored here. (default: None)</span>
<span class="sd">        logger:             If desired, a logger object for logging. (default: None, in which case</span>
<span class="sd">                            one will be built according to the config dict&#39;s verbose level.)</span>

<span class="sd">    Keyword Arguments:</span>

<span class="sd">        nbins (int):        How many bins to use. (Exactly three of nbins, bin_size, min_sep,</span>
<span class="sd">                            max_sep are required. If nbins is not given, it will be calculated from</span>
<span class="sd">                            the values of the other three, rounding up to the next highest integer.</span>
<span class="sd">                            In this case, bin_size will be readjusted to account for this rounding</span>
<span class="sd">                            up.)</span>
<span class="sd">        bin_size (float):   The width of the bins in log(separation). (Exactly three of nbins,</span>
<span class="sd">                            bin_size, min_sep, max_sep are required.  If bin_size is not given, it</span>
<span class="sd">                            will be calculated from the values of the other three.)</span>
<span class="sd">        min_sep (float):    The minimum separation in units of sep_units, if relevant. (Exactly</span>
<span class="sd">                            three of nbins, bin_size, min_sep, max_sep are required.  If min_sep is</span>
<span class="sd">                            not given, it will be calculated from the values of the other three.)</span>
<span class="sd">        max_sep (float):    The maximum separation in units of sep_units, if relevant. (Exactly</span>
<span class="sd">                            three of nbins, bin_size, min_sep, max_sep are required.  If max_sep is</span>
<span class="sd">                            not given, it will be calculated from the values of the other three.</span>

<span class="sd">        sep_units (str):    The units to use for the separation values, given as a string.  This</span>
<span class="sd">                            includes both min_sep and max_sep above, as well as the units of the</span>
<span class="sd">                            output distance values.  Valid options are arcsec, arcmin, degrees,</span>
<span class="sd">                            hours, radians.  (default: radians if angular units make sense, but for</span>
<span class="sd">                            3-d or flat 2-d positions, the default will just match the units of</span>
<span class="sd">                            x,y[,z] coordinates)</span>
<span class="sd">        bin_slop (float):   How much slop to allow in the placement of pairs in the bins.</span>
<span class="sd">                            If bin_slop = 1, then the bin into which a particular pair is placed</span>
<span class="sd">                            may be incorrect by at most 1.0 bin widths.  (default: None, which</span>
<span class="sd">                            means to use a bin_slop that gives a maximum error of 10% on any bin,</span>
<span class="sd">                            which has been found to yield good results for most application.</span>

<span class="sd">        nubins (int):       Analogous to nbins for the u values.  (The default is to calculate from</span>
<span class="sd">                            ubin_size = binsize, min_u = 0, max_u = 1, but this can be overridden</span>
<span class="sd">                            by specifying up to 3 of these four parametes.)</span>
<span class="sd">        ubin_size (float):  Analogous to bin_size for the u values. (default: bin_size)</span>
<span class="sd">        min_u (float):      Analogous to min_sep for the u values. (default: 0)</span>
<span class="sd">        max_u (float):      Analogous to max_sep for the u values. (default: 1)</span>

<span class="sd">        nvbins (int):       Analogous to nbins for the positive v values.  (The default is to</span>
<span class="sd">                            calculate from vbin_size = binsize, min_v = 0, max_v = 1, but this can</span>
<span class="sd">                            be overridden by specifying up to 3 of these four parametes.)</span>
<span class="sd">        vbin_size (float):  Analogous to bin_size for the v values. (default: bin_size)</span>
<span class="sd">        min_v (float):      Analogous to min_sep for the positive v values. (default: 0)</span>
<span class="sd">        max_v (float):      Analogous to max_sep for the positive v values. (default: 1)</span>

<span class="sd">        brute (bool):       Whether to use the &quot;brute force&quot; algorithm.  (default: False) Options</span>
<span class="sd">                            are:</span>

<span class="sd">                             - False (the default): Stop at non-leaf cells whenever the error in</span>
<span class="sd">                               the separation is compatible with the given bin_slop.</span>
<span class="sd">                             - True: Go to the leaves for both catalogs.</span>
<span class="sd">                             - 1: Always go to the leaves for cat1, but stop at non-leaf cells of</span>
<span class="sd">                               cat2 when the error is compatible with the given bin_slop.</span>
<span class="sd">                             - 2: Always go to the leaves for cat2, but stop at non-leaf cells of</span>
<span class="sd">                               cat1 when the error is compatible with the given bin_slop.</span>

<span class="sd">        verbose (int):      If no logger is provided, this will optionally specify a logging level</span>
<span class="sd">                            to use:</span>

<span class="sd">                             - 0 means no logging output</span>
<span class="sd">                             - 1 means to output warnings only (default)</span>
<span class="sd">                             - 2 means to output various progress information</span>
<span class="sd">                             - 3 means to output extensive debugging information</span>

<span class="sd">        log_file (str):     If no logger is provided, this will specify a file to write the logging</span>
<span class="sd">                            output.  (default: None; i.e. output to standard output)</span>
<span class="sd">        output_dots (bool): Whether to output progress dots during the calcualtion of the</span>
<span class="sd">                            correlation function. (default: False unless verbose is given and &gt;= 2,</span>
<span class="sd">                            in which case True)</span>

<span class="sd">        split_method (str): How to split the cells in the tree when building the tree structure.</span>
<span class="sd">                            Options are:</span>

<span class="sd">                            - mean = Use the arithmetic mean of the coordinate being split.</span>
<span class="sd">                              (default)</span>
<span class="sd">                            - median = Use the median of the coordinate being split.</span>
<span class="sd">                            - middle = Use the middle of the range; i.e. the average of the minimum</span>
<span class="sd">                              and maximum value.</span>
<span class="sd">                            - random: Use a random point somewhere in the middle two quartiles of</span>
<span class="sd">                              the range.</span>

<span class="sd">        min_top (int):      The minimum number of top layers to use when setting up the field.</span>
<span class="sd">                            (default: :math:`\\max(3, \\log_2(N_{\\rm cpu}))`)</span>
<span class="sd">        max_top (int):      The maximum number of top layers to use when setting up the field.</span>
<span class="sd">                            The top-level cells are where each calculation job starts. There will</span>
<span class="sd">                            typically be of order :math:`2^{\\rm max\\_top}` top-level cells.</span>
<span class="sd">                            (default: 10)</span>
<span class="sd">        precision (int):    The precision to use for the output values. This specifies how many</span>
<span class="sd">                            digits to write. (default: 4)</span>

<span class="sd">        metric (str):       Which metric to use for distance measurements.  Options are listed</span>
<span class="sd">                            above.  (default: &#39;Euclidean&#39;)</span>
<span class="sd">        bin_type (str):     What type of binning should be used.  Only one option currently.</span>
<span class="sd">                            (default: &#39;LogRUV&#39;)</span>
<span class="sd">        period (float):     For the &#39;Periodic&#39; metric, the period to use in all directions.</span>
<span class="sd">                            (default: None)</span>
<span class="sd">        xperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the x direction.</span>
<span class="sd">                            (default: period)</span>
<span class="sd">        yperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the y direction.</span>
<span class="sd">                            (default: period)</span>
<span class="sd">        zperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the z direction.</span>
<span class="sd">                            (default: period)</span>

<span class="sd">        var_method (str):   Which method to use for estimating the variance. Options are:</span>
<span class="sd">                            &#39;shot&#39;, &#39;jackknife&#39;, &#39;sample&#39;, &#39;bootstrap&#39;, &#39;marked_bootstrap&#39;.</span>
<span class="sd">                            (default: &#39;shot&#39;)</span>
<span class="sd">        num_bootstrap (int): How many bootstrap samples to use for the &#39;bootstrap&#39; and</span>
<span class="sd">                            &#39;marked_bootstrap&#39; var_methods.  (default: 500)</span>
<span class="sd">        rng (RandomState):  If desired, a numpy.random.RandomState instance to use for bootstrap</span>
<span class="sd">                            random number generation. (default: None)</span>

<span class="sd">        num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                            (default: use the number of cpu cores; this value can also be given in</span>
<span class="sd">                            the constructor in the config dict.)</span>

<span class="sd">                            .. note::</span>

<span class="sd">                                This won&#39;t work if the system&#39;s C compiler cannot use OpenMP</span>
<span class="sd">                                (e.g. clang prior to version 3.7.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_valid_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;nbins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for sep dimension.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in log(sep).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_sep&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum separation to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_sep&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum separation to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;sep_units&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">AngleUnit</span><span class="o">.</span><span class="n">valid_names</span><span class="p">,</span>
                <span class="s1">&#39;The units to use for min_sep and max_sep.  Also the units of the output &#39;</span>
                <span class="s1">&#39;distances&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_slop&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The fraction of a bin width by which it is ok to let the pairs miss the correct &#39;</span>
                <span class="s1">&#39;bin.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is to use 1 if bin_size &lt;= 0.1, or 0.1/bin_size if bin_size &gt; 0.1.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;nubins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for u dimension.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ubin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in u.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_u&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum u to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_u&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum u to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;nvbins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for positive v values.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;vbin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in v.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_v&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum |v| to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_v&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum |v| to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;brute&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                <span class="s1">&#39;Whether to use brute-force algorithm&#39;</span><span class="p">),</span>
        <span class="s1">&#39;verbose&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;How verbose the code should be during processing. &#39;</span><span class="p">,</span>
                <span class="s1">&#39;0 = Errors Only, 1 = Warnings, 2 = Progress, 3 = Debugging&#39;</span><span class="p">),</span>
        <span class="s1">&#39;log_file&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;If desired, an output file for the logging output.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is to write the output to stdout.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;output_dots&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;Whether to output dots to the stdout during the C++-level computation.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is True if verbose &gt;= 2 and there is no log_file.  Else False.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;split_method&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which method to use for splitting cells.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_top&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum number of top layers to use when setting up the field.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_top&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum number of top layers to use when setting up the field.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of digits after the decimal in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">,</span> <span class="s1">&#39;Arc&#39;</span><span class="p">,</span> <span class="s1">&#39;Periodic&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which metric to use for the distance measurements&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_type&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LogRUV&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which type of binning should be used&#39;</span><span class="p">),</span>
        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for all directions for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;xperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the x direction for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;yperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the y direction for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;zperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the z direction for the Periodic metric&#39;</span><span class="p">),</span>

        <span class="s1">&#39;var_method&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;jackknife&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;marked_bootstrap&#39;</span><span class="p">],</span>
                <span class="s1">&#39;The method to use for estimating the variance&#39;</span><span class="p">),</span>
        <span class="s1">&#39;num_bootstrap&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;How many bootstrap samples to use for the var_method=bootstrap and &#39;</span>
                <span class="s1">&#39;marked_bootstrap&#39;</span><span class="p">),</span>
        <span class="s1">&#39;num_threads&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;How many threads should be used. num_threads &lt;= 0 means auto based on num cores.&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Do this first to make sure we always have it for __del__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">merge_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">kwargs</span><span class="p">,</span><span class="n">BinnedCorr3</span><span class="o">.</span><span class="n">_valid_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_file&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="c1"># We&#39;ll make a bunch of attributes here, which we put into a namespace called _ro.</span>
        <span class="c1"># These are the core attributes that won&#39;t ever be changed after construction.</span>
        <span class="c1"># This is an efficiency optimization (both memory and flops), since it will allow</span>
        <span class="c1"># copy() to just copy a pointer to the _ro namespace without having to copy each</span>
        <span class="c1"># individual attribute separately.</span>
        <span class="c1"># The access of these attributes are all via read-only properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;output_dots&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;output_dots&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">Log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sep_units&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_sep_units</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;sep_units&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;radians&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_log_sep_units</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nbins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;max_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter max_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;min_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;bin_size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter bin_size&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_sep must be larger than min_sep&quot;</span><span class="p">)</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="n">bin_size</span><span class="p">))</span>
            <span class="c1"># Update self.bin_size given this value of nbins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>
            <span class="c1"># Note in this case, bin_size is saved as the nominal bin_size from the config</span>
            <span class="c1"># file, and self.bin_size is the one for the radial bins.  We&#39;ll use the nominal</span>
            <span class="c1"># bin_size as the default bin_size for u and v below.</span>
        <span class="k">elif</span> <span class="s1">&#39;bin_size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;max_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter max_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;min_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_sep must be larger than min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>
        <span class="k">elif</span> <span class="s1">&#39;max_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;min_sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;min_sep&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_sep, max_sep, bin_size, nbins are allowed.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;r: nbins = </span><span class="si">%d</span><span class="s2">, min,max sep = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;r: nbins = </span><span class="si">%d</span><span class="s2">, min,max sep = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2"> </span><span class="si">%s</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="c1"># The underscore-prefixed names are in natural units (radians for angles)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>  <span class="c1"># There is not Linear, but if I add it, need to apply</span>
                                            <span class="c1"># units to _bin_size in that case as well.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_u&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_u&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_u must be larger than min_u&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid range for u: </span><span class="si">%f</span><span class="s2"> - </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ubin_size&#39;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;nubins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="o">-</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;max_u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;min_u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;ubin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_u, max_u, ubin_size, nubins are allowed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nubins&#39;</span><span class="p">]</span>
            <span class="c1"># Allow min or max u to be implicit from nubins and ubin_size</span>
            <span class="k">if</span> <span class="s1">&#39;ubin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;min_u&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;max_u&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># Adjust ubin_size given the other values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;u: nbins = </span><span class="si">%d</span><span class="s2">, min,max = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_v&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_v&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_v must be larger than min_v&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid range for |v|: </span><span class="si">%f</span><span class="s2"> - </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vbin_size&#39;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;nvbins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="o">-</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;max_v&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;min_v&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;vbin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_v, max_v, vbin_size, nvbins are allowed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nvbins&#39;</span><span class="p">]</span>
            <span class="c1"># Allow min or max v to be implicit from nvbins and vbin_size</span>
            <span class="k">if</span> <span class="s1">&#39;vbin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;max_v&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># min_v not in config</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># Adjust vbin_size given the other values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;v: nbins = </span><span class="si">%d</span><span class="s2">, min,max = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">split_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split_method&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using split_method = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_top</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;min_top&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_top</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;max_top&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;bin_slop&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>  <span class="c1"># The stored bin_slop corresponds to lnr bins.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mf">0.100001</span><span class="p">:</span>  <span class="c1"># Add some numerical slop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Using bin_slop = </span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span><span class="o">+</span>
                    <span class="s2">&quot;The b parameter is bin_slop * bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                    <span class="s2">&quot;  bu = </span><span class="si">%g</span><span class="s2">, bv = </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span><span class="o">+</span>
                    <span class="s2">&quot;It is generally recommended to use b &lt;= 0.1 for most applications.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                    <span class="s2">&quot;Larger values of this b parameter may result in significant inaccuracies.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using bin_slop = </span><span class="si">%g</span><span class="s2">, b = </span><span class="si">%g</span><span class="s2">, bu = </span><span class="si">%g</span><span class="s2">, bv = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span>

        <span class="c1"># This makes nbins evenly spaced entries in log(r) starting with 0 with step bin_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">,</span>
                                      <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Offset by the position of the center of the first bin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span>
                                   <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span>
                                   <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">brute</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;brute&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing brute force calculation.&quot;</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;xperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;yperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;zperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">var_method</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;var_method&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">num_bootstrap</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;num_bootstrap&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for jackknife, etc. store the results of each pair of patches.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">rng</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span>

    <span class="c1"># Properties for all the read-only attributes (&quot;ro&quot; stands for &quot;read-only&quot;)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_dots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_log_sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_log_sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ubin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vbin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nubins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logr1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">v1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rnom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rnom1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_bintype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_nbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_min_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_min_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_max_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_max_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_bin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">split_method</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_top</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_top</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_slop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">brute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">brute</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">xperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">yperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">zperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">var_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">var_method</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">num_bootstrap</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_d1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_d2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d2</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_d3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_d3</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_corr&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_ok&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>     <span class="c1"># Remake this as needed.</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Oh well.  This is just lost in the copy.  Can&#39;t be pickled.</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_file&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>

<div class="viewcode-block" id="BinnedCorr3.clear"><a class="viewcode-back" href="../../correlation3.html#treecorr.BinnedCorr3.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all data vectors, the results dict, and any related values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_ok&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if there are any values accumulated yet.  (i.e. ntri &gt; 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="c1"># No op for all but NNCorrelation, which needs to add the tot value</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_trivially_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
        <span class="c1"># For now, ignore the metric.  Just be conservative about how much space we need.</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">s1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">,</span><span class="n">s2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="n">z3</span><span class="p">,</span><span class="n">s3</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="p">((</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z2</span><span class="o">-</span><span class="n">z3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z3</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">d3</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&gt;</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">s3</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span><span class="p">)</span>  <span class="c1"># The 2* is where we are being conservative.</span>

    <span class="k">def</span> <span class="nf">_process_all_auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Now the tricky part.  If using MPI, we need to divide up the jobs smartly.</span>
            <span class="c1"># The first point is to divvy up the auto jobs evenly.  This is where most of the</span>
            <span class="c1"># work is done, so we want those to be spreads as evenly as possibly across procs.</span>
            <span class="c1"># Therefore, if all indices are mine, then do the job.</span>
            <span class="c1"># This reduces the number of catalogs this machine needs to load up.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If none of the indices are mine, then it&#39;s not my job.</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># When only one or two of the indices are mine, then we follow the same kind of</span>
            <span class="c1"># procedure as we did in 2pt.  There, we decided based on the parity of i.</span>
            <span class="c1"># Here that turns into i mod 3.</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_auto</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> auto&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">process_auto</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">num_threads</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                            <span class="c1"># One point in c1, 2 in c2.</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross12&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> pair, which are too far apart &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># NNNCorrelation needs to add the tot value</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

                            <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                            <span class="c1"># One point in c2, 2 in c1.</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross12&#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># NNNCorrelation needs to add the tot value</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>

                        <span class="c1"># One point in each of c1, c2, c3</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                                    <span class="n">temp</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">, which are too far apart &#39;</span> <span class="o">+</span>
                                                     <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                    <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># NNNCorrelation needs to add the tot value</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                    <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                            <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_cross12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If n1 is n, then this can be simple.  Just split according to i.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># If not, then this looks like the decision for 2pt auto using j,k.</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">k</span><span class="o">-</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires both catalogs use the same patches.&quot;</span><span class="p">)</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                        <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="c1"># One point in c1, 2 in c2.</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross12&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> pair, which are too far apart &#39;</span> <span class="o">+</span>
                                             <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="ow">or</span> <span class="n">n1</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># NNNCorrelation needs to add the tot value</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

                    <span class="c1"># One point in each of c1, c2, c3</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">, which are too far apart &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># NNNCorrelation needs to add the tot value</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                        <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Just split up according to one of the catalogs.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">n2</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires all catalogs use the same patches.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires all catalogs use the same patches.&quot;</span><span class="p">)</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="n">n3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">)</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat3</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                        <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">):</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1"> cross&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">, which are too far apart &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="o">==</span><span class="n">k</span><span class="p">)</span>
                                    <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="ow">and</span> <span class="n">n3</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">k</span> <span class="ow">and</span> <span class="n">n2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">k</span> <span class="ow">and</span> <span class="n">n1</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="ow">or</span> <span class="p">(</span><span class="n">n1</span><span class="o">==</span><span class="n">n2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n1</span><span class="o">==</span><span class="n">n3</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n2</span><span class="o">==</span><span class="n">n3</span><span class="o">==</span><span class="mi">1</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># NNNCorrelation needs to add the tot value</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                        <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                    <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

<div class="viewcode-block" id="BinnedCorr3.getStat"><a class="viewcode-back" href="../../correlation3.html#treecorr.BinnedCorr3.getStat">[docs]</a>    <span class="k">def</span> <span class="nf">getStat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The standard statistic for the current correlation object as a 1-d array.</span>

<span class="sd">        Usually, this is just self.zeta.  But if the metric is TwoD, this becomes</span>
<span class="sd">        self.zeta.ravel().</span>

<span class="sd">        And for `GGGCorrelation`, it is the concatenation of the four different correlations</span>
<span class="sd">        [gam0.ravel(), gam1.ravel(), gam2.ravel(), gam3.ravel()].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>

<div class="viewcode-block" id="BinnedCorr3.getWeight"><a class="viewcode-back" href="../../correlation3.html#treecorr.BinnedCorr3.getWeight">[docs]</a>    <span class="k">def</span> <span class="nf">getWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The weight array for the current correlation object as a 1-d array.</span>

<span class="sd">        This is the weight array corresponding to `getStat`. Usually just self.weight, but</span>
<span class="sd">        raveled for TwoD and duplicated for GGGCorrelation to match what `getStat` does in</span>
<span class="sd">        those cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>

<div class="viewcode-block" id="BinnedCorr3.estimate_cov"><a class="viewcode-back" href="../../correlation3.html#treecorr.BinnedCorr3.estimate_cov">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate the covariance matrix based on the data</span>

<span class="sd">        This function will calculate an estimate of the covariance matrix according to the</span>
<span class="sd">        given method.</span>

<span class="sd">        Options for ``method`` include:</span>

<span class="sd">            - &#39;shot&#39; = The variance based on &quot;shot noise&quot; only.  This includes the Poisson</span>
<span class="sd">              counts of points for N statistics, shape noise for G statistics, and the observed</span>
<span class="sd">              scatter in the values for K statistics.  In this case, the returned covariance</span>
<span class="sd">              matrix will be diagonal, since there is no way to estimate the off-diagonal terms.</span>
<span class="sd">            - &#39;jackknife&#39; = A jackknife estimate of the covariance matrix based on the scatter</span>
<span class="sd">              in the measurement when excluding one patch at a time.</span>
<span class="sd">            - &#39;sample&#39; = An estimate based on the sample covariance of a set of samples,</span>
<span class="sd">              taken as the patches of the input catalog.</span>
<span class="sd">            - &#39;bootstrap&#39; = A bootstrap covariance estimate. It selects patches at random with</span>
<span class="sd">              replacement and then generates the statistic using all the auto-correlations at</span>
<span class="sd">              their selected repetition plus all the cross terms that aren&#39;t actually auto terms.</span>
<span class="sd">            - &#39;marked_bootstrap&#39; = An estimate based on a marked-point bootstrap resampling of the</span>
<span class="sd">              patches.  Similar to bootstrap, but only samples the patches of the first catalog and</span>
<span class="sd">              uses all patches from the second catalog that correspond to each patch selection of</span>
<span class="sd">              the first catalog.  cf. https://ui.adsabs.harvard.edu/abs/2008ApJ...681..726L/</span>

<span class="sd">        Both &#39;bootstrap&#39; and &#39;marked_bootstrap&#39; use the num_bootstrap parameter, which can be set on</span>
<span class="sd">        construction.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For most classes, there is only a single statistic, ``zeta``, so this calculates a</span>
<span class="sd">            covariance matrix for that vector.  `GGGCorrelation` has four: ``gam0``, ``gam1``,</span>
<span class="sd">            ``gam2``, and ``gam3``, so in this case the full data vector is ``gam0`` followed by</span>
<span class="sd">            ``gam1``, then ``gam2``, then ``gam3``, and this calculates the covariance matrix for</span>
<span class="sd">            that full vector including both statistics.  The helper function `getStat` returns the</span>
<span class="sd">            relevant statistic in all cases.</span>

<span class="sd">        In all cases, the relevant processing needs to already have been completed and finalized.</span>
<span class="sd">        And for all methods other than &#39;shot&#39;, the processing should have involved an appropriate</span>
<span class="sd">        number of patches -- preferably more patches than the length of the vector for your</span>
<span class="sd">        statistic, although this is not checked.</span>

<span class="sd">        The default data vector to use for the covariance matrix is given by the method</span>
<span class="sd">        `getStat`.  As noted above, this is usually just self.zeta.  However, there is an option</span>
<span class="sd">        to compute the covariance of some other function of the correlation object by providing</span>
<span class="sd">        an arbitrary function, ``func``, which should act on the current correlation object</span>
<span class="sd">        and return the data vector of interest.</span>

<span class="sd">        For instance, for an `GGGCorrelation`, you might want to compute the covariance of just</span>
<span class="sd">        gam0 and ignore the others.  In this case you could use</span>

<span class="sd">            &gt;&gt;&gt; func = lambda ggg: ggg.gam0</span>

<span class="sd">        The return value from this func should be a single numpy array. (This is not directly</span>
<span class="sd">        checked, but you&#39;ll probably get some kind of exception if it doesn&#39;t behave as expected.)</span>

<span class="sd">        .. note::</span>

<span class="sd">            The optional ``func`` parameter is not valid in conjunction with ``method=&#39;shot&#39;``.</span>
<span class="sd">            It only works for the methods that are based on patch combinations.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method (str):       Which method to use to estimate the covariance matrix.</span>
<span class="sd">            func (function):    A unary function that acts on the current correlation object and</span>
<span class="sd">                                returns the desired data vector. [default: None, which is</span>

<span class="sd">        Returns:</span>
<span class="sd">            A numpy array with the estimated covariance matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Need to convert it to a function of the first item in the list.</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">corrs</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">corrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">estimate_multi_cov</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">all_func</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_num_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_threads&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Set num_threads automatically from ncpu&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Set num_threads = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">set_omp_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords3</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">parse_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">,</span> <span class="n">coords3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coords</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Detected a change in catalog coordinate systems. &quot;</span><span class="o">+</span>
                                    <span class="s2">&quot;This probably doesn&#39;t make sense!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Detected a change in metric. &quot;</span><span class="o">+</span>
                                    <span class="s2">&quot;This probably doesn&#39;t make sense!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Periodic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">coords</span><span class="o">==</span><span class="s1">&#39;3d&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Periodic metric requires setting the period to use.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;period options are not valid for </span><span class="si">%s</span><span class="s2"> metric.&quot;</span><span class="o">%</span><span class="n">metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">coord_enum</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">metric_enum</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">:</span>
            <span class="c1"># Then our distances are all angles.  Convert from the chord distance to a real angle.</span>
            <span class="c1"># L = 2 sin(theta/2)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>

    <span class="k">def</span> <span class="nf">_get_minmax_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">:</span>
            <span class="c1"># The minimum separation we care about is that of the smallest size, which is</span>
            <span class="c1"># min_sep * min_u.  Do the same calculation as for 2pt to get to min_size.</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span>
            <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mf">3.</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>

            <span class="c1"># This time, the maximum size is d1 * b.  d1 can be as high as 2*max_sep.</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span>
            <span class="n">max_size</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">*</span> <span class="n">b2</span>
            <span class="k">return</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>

    <span class="c1"># The three-point versions of the covariance helpers.</span>
    <span class="c1"># Note: the word &quot;pairs&quot; in many of these was appropriate for 2pt, but in the 3pt case</span>
    <span class="c1"># these actually refer to triples (i,j,k).</span>

    <span class="k">def</span> <span class="nf">_get_npatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_xi_from_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
        <span class="c1"># Compute the xi data vector for the given list of pairs.</span>
        <span class="c1"># pairs is input as a list of (i,j) values.</span>

        <span class="c1"># This is the normal calculation.  It needs to be overridden when there are randoms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ij</span><span class="p">]</span> <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_jackknife_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># k=m=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># j=m=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># m=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">i</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># j=k=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># k=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">i</span> <span class="ow">and</span> <span class="n">m</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># j=0</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="n">i</span> <span class="ow">and</span> <span class="n">m</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">i</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="n">i</span> <span class="ow">and</span> <span class="n">m</span><span class="o">!=</span><span class="n">i</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sample_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># k=m=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># j=m=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># m=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># j=k=0</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># k=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># j=0</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">[(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">_marked_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                <span class="c1"># Select all pairs where first point is in indx (repeating i as appropriate)</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="c1"># Select all pairs where first point is in indx (repeating i as appropriate)</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="c1"># Select all pairs where first point is in indx (repeating i as appropriate)</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="c1"># Select all pairs where first point is in indx (repeating i as appropriate)</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_bootstrap_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                <span class="k">return</span> <span class="p">([</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">+</span>
                        <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">return</span> <span class="p">([</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">+</span>
                        <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">([</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Like for 2pt we want to avoid getting extra copies of what are actually</span>
            <span class="c1"># auto-correlations coming from two indices equalling each other in (i,j,k).</span>
            <span class="c1"># This time, get each (i,i,i) once.</span>
            <span class="c1"># Then get (i,i,j), (i,j,i), and (j,i,i) once per each (i,j) pair with i!=j</span>
            <span class="c1"># repeated as often as they show up in the double for loop.</span>
            <span class="c1"># Finally get all triples (i,j,k) where they are all different repeated as often</span>
            <span class="c1"># as they show up in the triple for loop.</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">return</span> <span class="p">([</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span>
                              <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">k</span> <span class="ow">and</span> <span class="n">j</span><span class="o">!=</span><span class="n">k</span><span class="p">)</span> <span class="p">])</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Mike Jarvis.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>