<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>treecorr.corr3base &mdash; TreeCorr 5.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            TreeCorr
          </a>
              <div class="version">
                5.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../catalog.html">Input Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation2.html">Two-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlation3.html">Three-point Correlation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metric.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binning.html">Binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binning3pt.html">Binning for 3-point correlations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shear.html">Shear Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../patches.html">Patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cov.html">Covariance Estimates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../field.html">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Using configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes from version 5.0 to 5.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Previous History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TreeCorr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">treecorr.corr3base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for treecorr.corr3base</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2003-2024 by Mike Jarvis</span>
<span class="c1">#</span>
<span class="c1"># TreeCorr is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: corr3base</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">coord</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_treecorr</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">merge_config</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">make_minimal_config</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">parse_metric</span><span class="p">,</span> <span class="n">metric_enum</span><span class="p">,</span> <span class="n">coord_enum</span><span class="p">,</span> <span class="n">set_omp_threads</span><span class="p">,</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">make_writer</span><span class="p">,</span> <span class="n">make_reader</span><span class="p">,</span> <span class="n">spin_by_letter</span>
<span class="kn">from</span> <span class="nn">.corr2base</span> <span class="kn">import</span> <span class="n">estimate_multi_cov</span><span class="p">,</span> <span class="n">build_multi_cov_design_matrix</span><span class="p">,</span> <span class="n">Corr2</span>
<span class="kn">from</span> <span class="nn">.catalog</span> <span class="kn">import</span> <span class="n">Catalog</span><span class="p">,</span> <span class="n">calculateMeanW</span>

<span class="k">class</span> <span class="nc">Namespace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="Corr3"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3">[docs]</a><span class="k">class</span> <span class="nc">Corr3</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;This class stores the results of a 3-point correlation calculation, along with some</span>
<span class="sd">    ancillary data.</span>

<span class="sd">    This is a base class that is not intended to be constructed directly.  But it has a few</span>
<span class="sd">    helper functions that derived classes can use to help perform their calculations.  See</span>
<span class="sd">    the derived classes for more details:</span>

<span class="sd">    - `NNNCorrelation` handles count-count-count correlation functions</span>
<span class="sd">    - `KKKCorrelation` handles scalar-scalar-scalar correlation functions</span>
<span class="sd">    - `GGGCorrelation` handles shear-shear-shear correlation functions</span>

<span class="sd">    Three-point correlations are a bit more complicated than two-point, since the data need</span>
<span class="sd">    to be binned in triangles, not just the separation between two points.</span>

<span class="sd">    There are currenlty three different ways to quantify the triangle shapes.</span>

<span class="sd">    1. The triangle can be defined by its three side lengths (i.e. SSS congruence).</span>
<span class="sd">       In this case, we characterize the triangles according to the following three parameters</span>
<span class="sd">       based on the three side lengths with d1 &gt;= d2 &gt;= d3.</span>

<span class="sd">        .. math::</span>

<span class="sd">            r &amp;= d2 \\</span>
<span class="sd">            u &amp;= \frac{d3}{d2} \\</span>
<span class="sd">            v &amp;= \pm \frac{(d1 - d2)}{d3} \\</span>

<span class="sd">        The orientation of the triangle is specified by the sign of v.</span>
<span class="sd">        Positive v triangles have the three sides d1,d2,d3 in counter-clockwise orientation.</span>
<span class="sd">        Negative v triangles have the three sides d1,d2,d3 in clockwise orientation.</span>

<span class="sd">        .. note::</span>

<span class="sd">            We always bin the same way for positive and negative v values, and the binning</span>
<span class="sd">            specification for v should just be for the positive values.  E.g. if you specify</span>
<span class="sd">            min_v=0.2, max_v=0.6, then TreeCorr will also accumulate triangles with</span>
<span class="sd">            -0.6 &lt; v &lt; -0.2 in addition to those with 0.2 &lt; v &lt; 0.6.</span>

<span class="sd">    2. The triangle can be defined by two of the sides and the angle between them (i.e. SAS</span>
<span class="sd">       congruence).  The vertex point between the two sides is considered point &quot;1&quot; (P1), so</span>
<span class="sd">       the two sides (opposite points 2 and 3) are called d2 and d3.  The angle between them is</span>
<span class="sd">       called phi, and it is measured in radians.</span>

<span class="sd">       The orientation is defined such that 0 &lt;= phi &lt;= pi is the angle sweeping from d2 to d3</span>
<span class="sd">       counter-clockwise.</span>

<span class="sd">       Unlike the SSS definition where every triangle is uniquely placed in a single bin, this</span>
<span class="sd">       definition forms a triangle with each object at the central vertex, P1, so for</span>
<span class="sd">       auto-correlations, each triangle is placed in bins three times.  For cross-correlations,</span>
<span class="sd">       the order of the points is such that objects in the first catalog are at the central</span>
<span class="sd">       vertex, P1, objects in the second catalog are at P2, which is opposite d2 (i.e.</span>
<span class="sd">       at the end of line segment d3 from P1), and objects in the third catalog are at P3,</span>
<span class="sd">       opposite d3 (i.e. at the end of d2 from P1).</span>

<span class="sd">    3. The third option is a multipole expansion of the SAS description.  This idea was initially</span>
<span class="sd">       developed by Chen &amp; Szapudi (2005, ApJ, 635, 743) and then further refined by</span>
<span class="sd">       Slepian &amp; Eisenstein (2015, MNRAS, 454, 4142), Philcox et al (2022, MNRAS, 509, 2457),</span>
<span class="sd">       and Porth et al (2024, A&amp;A, 689, 227).  The latter in particular showed how to use this</span>
<span class="sd">       method for non-spin-0 correlations (GGG in particular).</span>

<span class="sd">       The basic idea is to do a Fourier transform of the phi binning to convert the phi</span>
<span class="sd">       bins into n bins.</span>

<span class="sd">       .. math::</span>

<span class="sd">           \zeta(d_2, d_3, \phi) = \frac{1}{2\pi} \sum_n \mathcal{Z}_n(d_2,d_3) e^{i n \phi}</span>

<span class="sd">       Formally, this is exact if the sum goes from :math:`-\infty .. \infty`.  Truncating this</span>
<span class="sd">       sum at :math:`\pm n_\mathrm{max}` is similar to binning in theta with this many bins</span>
<span class="sd">       for :math:`\phi` within the range :math:`0 &lt;= \phi &lt;= \pi`.</span>

<span class="sd">       The above papers show that this multipole expansion allows for a much more efficient</span>
<span class="sd">       calculation, since it can be done with a kind of 2-point calculation.</span>
<span class="sd">       We provide methods to convert the multipole output into the SAS binning if desired, since</span>
<span class="sd">       that is often more convenient in practice.</span>

<span class="sd">    The constructor for all derived classes take a config dict as the first argument,</span>
<span class="sd">    since this is often how we keep track of parameters, but if you don&#39;t want to</span>
<span class="sd">    use one or if you want to change some parameters from what are in a config dict,</span>
<span class="sd">    then you can use normal kwargs, which take precedence over anything in the config dict.</span>

<span class="sd">    There are a number of possible definitions for the distance between two points, which</span>
<span class="sd">    are appropriate for different use cases.  These are specified by the ``metric`` parameter.</span>
<span class="sd">    The possible options are:</span>

<span class="sd">        - &#39;Euclidean&#39; = straight line Euclidean distance between two points.  For spherical</span>
<span class="sd">          coordinates (ra,dec without r), this is the chord distance between points on the</span>
<span class="sd">          unit sphere.</span>
<span class="sd">        - &#39;FisherRperp&#39; = the perpendicular component of the distance, following the</span>
<span class="sd">          definitions in Fisher et al, 1994 (MNRAS, 267, 927).</span>
<span class="sd">        - &#39;OldRperp&#39; = the perpendicular component of the distance using the definition</span>
<span class="sd">          of Rperp from TreeCorr v3.x.</span>
<span class="sd">        - &#39;Rperp&#39; = an alias for FisherRperp.  You can change it to be an alias for</span>
<span class="sd">          OldRperp if you want by setting ``treecorr.Rperp_alias = &#39;OldRperp&#39;`` before</span>
<span class="sd">          using it.</span>
<span class="sd">        - &#39;Rlens&#39; = the distance from the first object (taken to be a lens) to the line</span>
<span class="sd">          connecting Earth and each of the other two objects (taken to be lensed sources).</span>
<span class="sd">        - &#39;Arc&#39; = the true great circle distance for spherical coordinates.</span>
<span class="sd">        - &#39;Periodic&#39; = Like Euclidean, but with periodic boundaries.</span>

<span class="sd">          .. note::</span>

<span class="sd">            The triangles for three-point correlations can become ambiguous if a triangle</span>
<span class="sd">            side length d &gt; period/2, which means for the SSS triangle definition, max_sep</span>
<span class="sd">            (the maximum d2) should be less than period/4, and for SAS, max_sep should be less</span>
<span class="sd">            than period/2.  This is not enforced.</span>

<span class="sd">    See `Metrics` for more information about these various metric options.</span>

<span class="sd">    There are three allowed value for the ``bin_type`` for three-point correlations.</span>

<span class="sd">        - &#39;LogRUV&#39; uses the SSS description given above converted to r,u,v. The bin steps will be</span>
<span class="sd">          uniform in log(r) from log(min_sep) .. log(max_sep).  The u and v values are binned</span>
<span class="sd">          linearly from min_u .. max_u and min_v .. max_v.</span>
<span class="sd">        - &#39;LogSAS&#39; uses the SAS description given above. The bin steps will be uniform in log(d)</span>
<span class="sd">          for both d2 and d3 from log(min_sep) .. log(max_sep).  The phi values are binned</span>
<span class="sd">          linearly from min_phi .. max_phi.  This is the default.</span>
<span class="sd">        - &#39;LogMultipole&#39; uses the multipole description given above. The bin steps will be uniform</span>
<span class="sd">          in log(d) for both d2 and d3 from log(min_sep) .. log(max_sep), and the n value range</span>
<span class="sd">          from -max_n .. max_n, inclusive.</span>

<span class="sd">    Objects of any `Corr3` subclass hold the following attributes:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nbins:      The number of bins in logr where r = d2.</span>
<span class="sd">        bin_size:   The size of the bins in logr.</span>
<span class="sd">        min_sep:    The minimum separation being considered.</span>
<span class="sd">        max_sep:    The maximum separation being considered.</span>
<span class="sd">        logr1d:     The nominal centers of the nbins bins in log(r).</span>

<span class="sd">    If the bin_type is LogRUV, then it will have these attributes:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nubins:     The number of bins in u where u = d3/d2.</span>
<span class="sd">        ubin_size:  The size of the bins in u.</span>
<span class="sd">        min_u:      The minimum u being considered.</span>
<span class="sd">        max_u:      The maximum u being considered.</span>
<span class="sd">        nvbins:     The number of bins in v where v = +-(d1-d2)/d3.</span>
<span class="sd">        vbin_size:  The size of the bins in v.</span>
<span class="sd">        min_v:      The minimum v being considered.</span>
<span class="sd">        max_v:      The maximum v being considered.</span>
<span class="sd">        u1d:        The nominal centers of the nubins bins in u.</span>
<span class="sd">        v1d:        The nominal centers of the nvbins bins in v.</span>

<span class="sd">    If the bin_type is LogSAS, then it will have these attributes:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nphi_bins:  The number of bins in phi.</span>
<span class="sd">        phi_bin_size: The size of the bins in phi.</span>
<span class="sd">        min_phi:    The minimum phi being considered.</span>
<span class="sd">        max_phi:    The maximum phi being considered.</span>
<span class="sd">        phi1d:      The nominal centers of the nphi_bins bins in phi.</span>

<span class="sd">    If the bin_type is LogMultipole, then it will have these attributes:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_n:      The maximum multipole index n being stored.</span>
<span class="sd">        n1d:        The multipole index n in the 2*max_n+1 bins of the third bin direction.</span>

<span class="sd">    In addition, the following attributes are numpy arrays whose shape is:</span>

<span class="sd">        * (nbins, nubins, nvbins) if bin_type is LogRUV</span>
<span class="sd">        * (nbins, nbins, nphi_bins) if bin_type is LogSAS</span>
<span class="sd">        * (nbins, nbins, 2*max_n+1) if bin_type is LogMultipole</span>

<span class="sd">    If bin_type is LogRUV:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logr:       The nominal center of each bin in log(r).</span>
<span class="sd">        rnom:       The nominal center of each bin converted to regular distance.</span>
<span class="sd">                    i.e. r = exp(logr).</span>
<span class="sd">        u:          The nominal center of each bin in u.</span>
<span class="sd">        v:          The nominal center of each bin in v.</span>
<span class="sd">        meanu:      The (weighted) mean value of u for the triangles in each bin.</span>
<span class="sd">        meanv:      The (weighted) mean value of v for the triangles in each bin.</span>

<span class="sd">    If bin_type is LogSAS:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logd2:      The nominal center of each bin in log(d2).</span>
<span class="sd">        d2nom:      The nominal center of each bin converted to regular d2 distance.</span>
<span class="sd">                    i.e. d2 = exp(logd2).</span>
<span class="sd">        logd3:      The nominal center of each bin in log(d3).</span>
<span class="sd">        d3nom:      The nominal center of each bin converted to regular d3 distance.</span>
<span class="sd">                    i.e. d3 = exp(logd3).</span>
<span class="sd">        phi:        The nominal center of each angular bin.</span>
<span class="sd">        meanphi:    The (weighted) mean value of phi for the triangles in each bin.</span>

<span class="sd">    If bin_type is LogMultipole:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logd2:      The nominal center of each bin in log(d2).</span>
<span class="sd">        d2nom:      The nominal center of each bin converted to regular d2 distance.</span>
<span class="sd">                    i.e. d2 = exp(logd2).</span>
<span class="sd">        logd3:      The nominal center of each bin in log(d3).</span>
<span class="sd">        d3nom:      The nominal center of each bin converted to regular d3 distance.</span>
<span class="sd">                    i.e. d3 = exp(logd3).</span>
<span class="sd">        n:          The multipole index n for each bin.</span>

<span class="sd">    For any bin_type:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        meand1:     The (weighted) mean value of d1 for the triangles in each bin.</span>
<span class="sd">        meanlogd1:  The (weighted) mean value of log(d1) for the triangles in each bin.</span>
<span class="sd">        meand2:     The (weighted) mean value of d2 (aka r) for the triangles in each bin.</span>
<span class="sd">        meanlogd2:  The (weighted) mean value of log(d2) for the triangles in each bin.</span>
<span class="sd">        meand3:     The (weighted) mean value of d3 for the triangles in each bin.</span>
<span class="sd">        meanlogd3:  The (weighted) mean value of log(d3) for the triangles in each bin.</span>
<span class="sd">        weight:     The total weight in each bin.</span>
<span class="sd">        ntri:       The number of triangles going into each bin (including those where one or</span>
<span class="sd">                    more objects have w=0).</span>

<span class="sd">    If ``sep_units`` are given (either in the config dict or as a named kwarg) then the distances</span>
<span class="sd">    will all be in these units.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If you separate out the steps of the `process` command and use `process_auto`</span>
<span class="sd">        and/or `process_cross`, then the units will not be applied to ``meanr`` or</span>
<span class="sd">        ``meanlogr`` until the ``finalize`` function is called.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        config (dict):      A configuration dict that can be used to pass in the below kwargs if</span>
<span class="sd">                            desired.  This dict is allowed to have addition entries in addition</span>
<span class="sd">                            to those listed below, which are ignored here. (default: None)</span>
<span class="sd">        logger:             If desired, a logger object for logging. (default: None, in which case</span>
<span class="sd">                            one will be built according to the config dict&#39;s verbose level.)</span>

<span class="sd">    Keyword Arguments:</span>

<span class="sd">        nbins (int):        How many bins to use. (Exactly three of nbins, bin_size, min_sep,</span>
<span class="sd">                            max_sep are required. If nbins is not given or set to None, it will be</span>
<span class="sd">                            calculated from the values of the other three, rounding up to the next</span>
<span class="sd">                            highest integer. In this case, bin_size will be readjusted to account</span>
<span class="sd">                            for this rounding up.)</span>
<span class="sd">        bin_size (float):   The width of the bins in log(separation). (Exactly three of nbins,</span>
<span class="sd">                            bin_size, min_sep, max_sep are required.  If bin_size is not given or</span>
<span class="sd">                            set to None, it will be calculated from the values of the other three.)</span>
<span class="sd">        min_sep (float):    The minimum separation in units of sep_units, if relevant. (Exactly</span>
<span class="sd">                            three of nbins, bin_size, min_sep, max_sep are required.  If min_sep is</span>
<span class="sd">                            not given or set to None, it will be calculated from the values of the</span>
<span class="sd">                            other three.)</span>
<span class="sd">        max_sep (float):    The maximum separation in units of sep_units, if relevant. (Exactly</span>
<span class="sd">                            three of nbins, bin_size, min_sep, max_sep are required.  If max_sep is</span>
<span class="sd">                            not given or set to None, it will be calculated from the values of the</span>
<span class="sd">                            other three.)</span>

<span class="sd">        sep_units (str):    The units to use for the separation values, given as a string.  This</span>
<span class="sd">                            includes both min_sep and max_sep above, as well as the units of the</span>
<span class="sd">                            output distance values.  Valid options are arcsec, arcmin, degrees,</span>
<span class="sd">                            hours, radians.  (default: radians if angular units make sense, but for</span>
<span class="sd">                            3-d or flat 2-d positions, the default will just match the units of</span>
<span class="sd">                            x,y[,z] coordinates)</span>
<span class="sd">        bin_slop (float):   How much slop to allow in the placement of triangles in the bins.</span>
<span class="sd">                            If bin_slop = 1, then the bin into which a particular pair is placed</span>
<span class="sd">                            may be incorrect by at most 1.0 bin widths.  (default: None, which</span>
<span class="sd">                            means to use a bin_slop that gives a maximum error of 10% on any bin,</span>
<span class="sd">                            which has been found to yield good results for most application.)</span>
<span class="sd">        angle_slop (float): How much slop to allow in the angular direction. This works very</span>
<span class="sd">                            similarly to bin_slop, but applies to the projection angle of a pair</span>
<span class="sd">                            of cells. The projection angle for any two objects in a pair of cells</span>
<span class="sd">                            will differ by no more than angle_slop radians from the projection</span>
<span class="sd">                            angle defined by the centers of the cells. (default: 0.1)</span>
<span class="sd">        brute (bool):       Whether to use the &quot;brute force&quot; algorithm.  (default: False) Options</span>
<span class="sd">                            are:</span>

<span class="sd">                             - False (the default): Stop at non-leaf cells whenever the error in</span>
<span class="sd">                               the separation is compatible with the given bin_slop and angle_slop.</span>
<span class="sd">                             - True: Go to the leaves for both catalogs.</span>
<span class="sd">                             - 1: Always go to the leaves for cat1, but stop at non-leaf cells of</span>
<span class="sd">                               cat2 when the error is compatible with the given slop values.</span>
<span class="sd">                             - 2: Always go to the leaves for cat2, but stop at non-leaf cells of</span>
<span class="sd">                               cat1 when the error is compatible with the given slop values.</span>


<span class="sd">        nphi_bins (int):    Analogous to nbins for the phi values when bin_type=LogSAS.  (The</span>
<span class="sd">                            default is to calculate from phi_bin_size = bin_size, min_phi = 0,</span>
<span class="sd">                            max_u = np.pi, but this can be overridden by specifying up to 3 of</span>
<span class="sd">                            these four parametes.)</span>
<span class="sd">        phi_bin_size (float): Analogous to bin_size for the phi values. (default: bin_size)</span>
<span class="sd">        min_phi (float):    Analogous to min_sep for the phi values. (default: 0)</span>
<span class="sd">        max_phi (float):    Analogous to max_sep for the phi values. (default: np.pi)</span>
<span class="sd">        phi_units (str):    The units to use for the phi values, given as a string.  This</span>
<span class="sd">                            includes both min_phi and max_phi above, as well as the units of the</span>
<span class="sd">                            output meanphi values.  Valid options are arcsec, arcmin, degrees,</span>
<span class="sd">                            hours, radians.  (default: radians)</span>

<span class="sd">        max_n (int):        The maximum value of n to store for the multipole binning.</span>
<span class="sd">                            (required if bin_type=LogMultipole)</span>

<span class="sd">        nubins (int):       Analogous to nbins for the u values when bin_type=LogRUV.  (The default</span>
<span class="sd">                            is to calculate from ubin_size = bin_size, min_u = 0, max_u = 1, but</span>
<span class="sd">                            this can be overridden by specifying up to 3 of these four parametes.)</span>
<span class="sd">        ubin_size (float):  Analogous to bin_size for the u values. (default: bin_size)</span>
<span class="sd">        min_u (float):      Analogous to min_sep for the u values. (default: 0)</span>
<span class="sd">        max_u (float):      Analogous to max_sep for the u values. (default: 1)</span>

<span class="sd">        nvbins (int):       Analogous to nbins for the positive v values when bin__type=LogRUV.</span>
<span class="sd">                            (The default is to calculate from vbin_size = bin_size, min_v = 0,</span>
<span class="sd">                            max_v = 1, but this can be overridden by specifying up to 3 of these</span>
<span class="sd">                            four parametes.)</span>
<span class="sd">        vbin_size (float):  Analogous to bin_size for the v values. (default: bin_size)</span>
<span class="sd">        min_v (float):      Analogous to min_sep for the positive v values. (default: 0)</span>
<span class="sd">        max_v (float):      Analogous to max_sep for the positive v values. (default: 1)</span>

<span class="sd">        verbose (int):      If no logger is provided, this will optionally specify a logging level</span>
<span class="sd">                            to use:</span>

<span class="sd">                             - 0 means no logging output</span>
<span class="sd">                             - 1 means to output warnings only (default)</span>
<span class="sd">                             - 2 means to output various progress information</span>
<span class="sd">                             - 3 means to output extensive debugging information</span>

<span class="sd">        log_file (str):     If no logger is provided, this will specify a file to write the logging</span>
<span class="sd">                            output.  (default: None; i.e. output to standard output)</span>
<span class="sd">        output_dots (bool): Whether to output progress dots during the calcualtion of the</span>
<span class="sd">                            correlation function. (default: False unless verbose is given and &gt;= 2,</span>
<span class="sd">                            in which case True)</span>

<span class="sd">        split_method (str): How to split the cells in the tree when building the tree structure.</span>
<span class="sd">                            Options are:</span>

<span class="sd">                            - mean = Use the arithmetic mean of the coordinate being split.</span>
<span class="sd">                              (default)</span>
<span class="sd">                            - median = Use the median of the coordinate being split.</span>
<span class="sd">                            - middle = Use the middle of the range; i.e. the average of the minimum</span>
<span class="sd">                              and maximum value.</span>
<span class="sd">                            - random: Use a random point somewhere in the middle two quartiles of</span>
<span class="sd">                              the range.</span>

<span class="sd">        min_top (int):      The minimum number of top layers to use when setting up the field.</span>
<span class="sd">                            (default: :math:`\max(3, \log_2(N_{\rm cpu}))`)</span>
<span class="sd">        max_top (int):      The maximum number of top layers to use when setting up the field.</span>
<span class="sd">                            The top-level cells are where each calculation job starts. There will</span>
<span class="sd">                            typically be of order :math:`2^{\rm max\_top}` top-level cells.</span>
<span class="sd">                            (default: 10)</span>
<span class="sd">        precision (int):    The precision to use for the output values. This specifies how many</span>
<span class="sd">                            digits to write. (default: 4)</span>

<span class="sd">        metric (str):       Which metric to use for distance measurements.  Options are listed</span>
<span class="sd">                            above.  (default: &#39;Euclidean&#39;)</span>
<span class="sd">        bin_type (str):     What type of binning should be used.  Options are listed above.</span>
<span class="sd">                            (default: &#39;LogSAS&#39;)</span>
<span class="sd">        min_rpar (float):   The minimum difference in Rparallel to allow for pairs being included</span>
<span class="sd">                            in the correlation function.  (default: None)</span>
<span class="sd">        max_rpar (float):   The maximum difference in Rparallel to allow for pairs being included</span>
<span class="sd">                            in the correlation function.  (default: None)</span>
<span class="sd">        period (float):     For the &#39;Periodic&#39; metric, the period to use in all directions.</span>
<span class="sd">                            (default: None)</span>
<span class="sd">        xperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the x direction.</span>
<span class="sd">                            (default: period)</span>
<span class="sd">        yperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the y direction.</span>
<span class="sd">                            (default: period)</span>
<span class="sd">        zperiod (float):    For the &#39;Periodic&#39; metric, the period to use in the z direction.</span>
<span class="sd">                            (default: period)</span>

<span class="sd">        var_method (str):   Which method to use for estimating the variance. Options are:</span>
<span class="sd">                            &#39;shot&#39;, &#39;jackknife&#39;, &#39;sample&#39;, &#39;bootstrap&#39;, &#39;marked_bootstrap&#39;.</span>
<span class="sd">                            (default: &#39;shot&#39;)</span>
<span class="sd">        num_bootstrap (int): How many bootstrap samples to use for the &#39;bootstrap&#39; and</span>
<span class="sd">                            &#39;marked_bootstrap&#39; var_methods.  (default: 500)</span>
<span class="sd">        cross_patch_weight (str): How to weight pairs that cross between two patches when one patch</span>
<span class="sd">                            is deselected (e.g. in a jackknife sense) and the other is selected.</span>
<span class="sd">                            (default None)</span>
<span class="sd">        rng (RandomState):  If desired, a numpy.random.RandomState instance to use for bootstrap</span>
<span class="sd">                            random number generation. (default: None)</span>

<span class="sd">        num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                            (default: use the number of cpu cores; this value can also be given in</span>
<span class="sd">                            the constructor in the config dict.)</span>

<span class="sd">                            .. note::</span>

<span class="sd">                                This won&#39;t work if the system&#39;s C compiler cannot use OpenMP</span>
<span class="sd">                                (e.g. clang prior to version 3.7.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_default_angle_slop</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># A dict pointing from _letters to cls.  E.g. _lookup_dict[&#39;GGG&#39;] = GGGCorrelation</span>
    <span class="n">_lookup_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">_valid_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;nbins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for sep dimension.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in log(sep).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_sep&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum separation to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_sep&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum separation to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;sep_units&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">AngleUnit</span><span class="o">.</span><span class="n">valid_names</span><span class="p">,</span>
                <span class="s1">&#39;The units to use for min_sep and max_sep.  Also the units of the output &#39;</span>
                <span class="s1">&#39;distances&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_slop&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The fraction of a bin width by which it is ok to let the triangles miss the &#39;</span>
                <span class="s1">&#39;correct bin.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is to use 1 if bin_size &lt;= 0.1, or 0.1/bin_size if bin_size &gt; 0.1.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;angle_slop&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum difference in the projection angle for any pair of objects relative &#39;</span>
                <span class="s1">&#39;to that of the pair of cells being used for an accumulated triangle&#39;</span><span class="p">),</span>
        <span class="s1">&#39;nubins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for u dimension.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ubin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in u.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_u&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum u to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_u&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum u to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;nvbins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for positive v values.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;vbin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in v.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_v&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum |v| to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_v&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum |v| to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;nphi_bins&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of output bins to use for phi dimension.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;phi_bin_size&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The size of the output bins in phi.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_phi&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum phi to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_phi&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum phi to include in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;phi_units&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">AngleUnit</span><span class="o">.</span><span class="n">valid_names</span><span class="p">,</span>
                <span class="s1">&#39;The units to use for min_phi and max_phi.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_n&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum n to store for multipole binning.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;brute&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                <span class="s1">&#39;Whether to use brute-force algorithm&#39;</span><span class="p">),</span>
        <span class="s1">&#39;verbose&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;How verbose the code should be during processing. &#39;</span><span class="p">,</span>
                <span class="s1">&#39;0 = Errors Only, 1 = Warnings, 2 = Progress, 3 = Debugging&#39;</span><span class="p">),</span>
        <span class="s1">&#39;log_file&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;If desired, an output file for the logging output.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is to write the output to stdout.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;output_dots&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;Whether to output dots to the stdout during the C++-level computation.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The default is True if verbose &gt;= 2 and there is no log_file.  Else False.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;split_method&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which method to use for splitting cells.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_top&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum number of top layers to use when setting up the field.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_top&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum number of top layers to use when setting up the field.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The number of digits after the decimal in the output.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">,</span> <span class="s1">&#39;Rperp&#39;</span><span class="p">,</span> <span class="s1">&#39;FisherRperp&#39;</span><span class="p">,</span> <span class="s1">&#39;OldRperp&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;Rlens&#39;</span><span class="p">,</span> <span class="s1">&#39;Arc&#39;</span><span class="p">,</span> <span class="s1">&#39;Periodic&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which metric to use for the distance measurements&#39;</span><span class="p">),</span>
        <span class="s1">&#39;bin_type&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LogRUV&#39;</span><span class="p">,</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Which type of binning should be used&#39;</span><span class="p">),</span>
        <span class="s1">&#39;min_rpar&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The minimum difference in Rparallel for pairs to include&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max_rpar&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The maximum difference in Rparallel for pairs to include&#39;</span><span class="p">),</span>
        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for all directions for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;xperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the x direction for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;yperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the y direction for the Periodic metric&#39;</span><span class="p">),</span>
        <span class="s1">&#39;zperiod&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;The period to use for the z direction for the Periodic metric&#39;</span><span class="p">),</span>

        <span class="s1">&#39;var_method&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;jackknife&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;marked_bootstrap&#39;</span><span class="p">],</span>
                <span class="s1">&#39;The method to use for estimating the variance&#39;</span><span class="p">),</span>
        <span class="s1">&#39;num_bootstrap&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;How many bootstrap samples to use for the var_method=bootstrap and &#39;</span>
                <span class="s1">&#39;marked_bootstrap&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cross_patch_weight&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">],</span>
                <span class="s1">&#39;How to weight pairs that cross between a selected and unselected patch&#39;</span><span class="p">),</span>
        <span class="s1">&#39;num_threads&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;How many threads should be used. num_threads &lt;= 0 means auto based on num cores.&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Do this first to make sure we always have it for __del__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">merge_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">kwargs</span><span class="p">,</span><span class="n">Corr3</span><span class="o">.</span><span class="n">_valid_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="s1">&#39;treecorr.Corr3&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_file&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># We&#39;ll make a bunch of attributes here, which we put into a namespace called _ro.</span>
        <span class="c1"># These are the core attributes that won&#39;t ever be changed after construction.</span>
        <span class="c1"># This is an efficiency optimization (both memory and flops), since it will allow</span>
        <span class="c1"># copy() to just copy a pointer to the _ro namespace without having to copy each</span>
        <span class="c1"># individual attribute separately.</span>
        <span class="c1"># The access of these attributes are all via read-only properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;output_dots&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;output_dots&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_type&#39;</span><span class="p">,</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sep_units&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_sep_units</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;sep_units&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;radians&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_log_sep_units</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nbins&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter max_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter bin_size&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_sep must be larger than min_sep&quot;</span><span class="p">)</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="n">bin_size</span><span class="p">))</span>
            <span class="c1"># Update self.bin_size given this value of nbins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>
            <span class="c1"># Note in this case, bin_size is saved as the nominal bin_size from the config</span>
            <span class="c1"># file, and self.bin_size is the one for the radial bins.  We&#39;ll use the nominal</span>
            <span class="c1"># bin_size as the default bin_size for u and v below.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter max_sep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_sep must be larger than min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter min_sep&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_sep, max_sep, bin_size, nbins are allowed.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sep&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">])</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_size&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;r: nbins = </span><span class="si">%d</span><span class="s2">, min,max sep = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;r: nbins = </span><span class="si">%d</span><span class="s2">, min,max sep = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2"> </span><span class="si">%s</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="c1"># The underscore-prefixed names are in natural units (radians for angles)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>  <span class="c1"># There is no Linear, but if I add it, need to apply</span>
                                            <span class="c1"># units to _bin_size in that case as well.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;max_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;nphi_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_bin_size&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;max_n&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is invalid for bin_type=LogRUV&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span> <span class="o">=</span> <span class="n">_treecorr</span><span class="o">.</span><span class="n">LogRUV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_u&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_u&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid range for u: </span><span class="si">%f</span><span class="s2"> - </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_u must be larger than min_u&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ubin_size&#39;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;nubins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="o">-</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;max_u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;min_u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;ubin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_u, max_u, ubin_size, nubins are allowed.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nubins&#39;</span><span class="p">]</span>
                <span class="c1"># Allow min or max u to be implicit from nubins and ubin_size</span>
                <span class="k">if</span> <span class="s1">&#39;ubin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;min_u&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;max_u&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="c1"># Adjust ubin_size given the other values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;u: nbins = </span><span class="si">%d</span><span class="s2">, min,max = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_v&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_v&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid range for |v|: </span><span class="si">%f</span><span class="s2"> - </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_v must be larger than min_v&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vbin_size&#39;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;nvbins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="o">-</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;max_v&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;min_v&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;vbin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_v, max_v, vbin_size, nvbins are allowed.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nvbins&#39;</span><span class="p">]</span>
                <span class="c1"># Allow min or max v to be implicit from nvbins and vbin_size</span>
                <span class="k">if</span> <span class="s1">&#39;vbin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;max_v&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># min_v not in config</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
            <span class="c1"># Adjust vbin_size given the other values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;v: nbins = </span><span class="si">%d</span><span class="s2">, min,max = </span><span class="si">%g</span><span class="s2">..</span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min_u&#39;</span><span class="p">,</span> <span class="s1">&#39;max_u&#39;</span><span class="p">,</span> <span class="s1">&#39;nubins&#39;</span><span class="p">,</span> <span class="s1">&#39;ubin_size&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;min_v&#39;</span><span class="p">,</span> <span class="s1">&#39;max_v&#39;</span><span class="p">,</span> <span class="s1">&#39;nvbins&#39;</span><span class="p">,</span> <span class="s1">&#39;vbin_size&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is invalid for bin_type=LogSAS&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span> <span class="o">=</span> <span class="n">_treecorr</span><span class="o">.</span><span class="n">LogSAS</span>
            <span class="c1"># Note: we refer to phi as u in the _ro namespace to make function calls easier.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phi_units&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_phi_units</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;phi_units&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;radians&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_phi&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_phi&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid range for phi: </span><span class="si">%f</span><span class="s2"> - </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_phi must be larger than min_phi&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phi_bin_size&#39;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;nphi_bins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span><span class="o">-</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;max_phi&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;min_phi&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
                    <span class="ow">and</span> <span class="s1">&#39;phi_bin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only 3 of min_phi, max_phi, phi_bin_size, and nphi_bins are &quot;</span>
                                <span class="s2">&quot;allowed.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nphi_bins&#39;</span><span class="p">]</span>
                <span class="c1"># Allow min or max phi to be implicit from nphi_bins and phi_bin_size</span>
                <span class="k">if</span> <span class="s1">&#39;phi_bin_size&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;max_phi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># min_phi not in config</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Adjust phi_bin_size given the other values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min_u&#39;</span><span class="p">,</span> <span class="s1">&#39;max_u&#39;</span><span class="p">,</span> <span class="s1">&#39;nubins&#39;</span><span class="p">,</span> <span class="s1">&#39;ubin_size&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;min_v&#39;</span><span class="p">,</span> <span class="s1">&#39;max_v&#39;</span><span class="p">,</span> <span class="s1">&#39;nvbins&#39;</span><span class="p">,</span> <span class="s1">&#39;vbin_size&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;min_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;max_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;nphi_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_bin_size&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is invalid for bin_type=LogMultipole&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span> <span class="o">=</span> <span class="n">_treecorr</span><span class="o">.</span><span class="n">LogMultipole</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_n&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing required parameter max_n&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_n&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_n must be non-negative&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover  (Already checked by config layer)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid bin_type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">split_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split_method&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using split_method = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_top</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;min_top&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_top</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;max_top&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;bin_slop&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">angle_slop</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;angle_slop&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">angle_slop</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;angle_slop&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_angle_slop</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>  <span class="c1"># The stored bin_slop corresponds to lnr bins.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LogMultipole</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LogMultipole</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mf">0.100001</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Using bin_slop = </span><span class="si">%g</span><span class="s2">, angle_slop = </span><span class="si">%g</span><span class="s2">, bin_size = </span><span class="si">%g</span><span class="s2"> (b = </span><span class="si">%g</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                <span class="s2">&quot;It is recommended to use either bin_slop &lt;= </span><span class="si">%g</span><span class="s2"> or angle_slop &lt;= 0.1.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="mf">0.1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span><span class="o">+</span>
                <span class="s2">&quot;Larger values of bin_slop/angle_slop may result in significant inaccuracies.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using bin_slop = </span><span class="si">%g</span><span class="s2">, angle_slop = </span><span class="si">%g</span><span class="s2"> (b = </span><span class="si">%g</span><span class="s2">, bu = </span><span class="si">%g</span><span class="s2">, bv = </span><span class="si">%g</span><span class="s2">)&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span>

        <span class="c1"># This makes nbins evenly spaced entries in log(r) starting with 0 with step bin_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span><span class="p">,</span>
                                      <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Offset by the position of the center of the first bin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span>
                                       <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ubin_size</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span>
                                       <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vbin_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="c1"># LogSAS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span><span class="p">,</span>
                                         <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi1d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                     <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d2nom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logd2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d3nom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logd3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span><span class="o">.</span><span class="n">shape</span>
            <span class="c1"># Also name these with the same names as above to make them easier to use.</span>
            <span class="c1"># We have properties to alias meanu as meanphi. meanv will remain all 0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># LogMultipole</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                     <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logr1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d2nom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logd2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d3nom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logd3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">n1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span><span class="o">.</span><span class="n">shape</span>
            <span class="c1"># Also name these with the same names as above to make them easier to use.</span>
            <span class="c1"># We won&#39;t use them for this bin type though.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># We always keep track of these.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varzeta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Sub-classes will allocate space for the ones we actually need.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">brute</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;brute&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing brute force calculation.&quot;</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_rpar</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;min_rpar&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_rpar</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;max_rpar&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_rpar</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_rpar</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min_rpar must be &lt;= max_rpar&quot;</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;xperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;yperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;zperiod&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">period</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">var_method</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;var_method&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">num_bootstrap</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;num_bootstrap&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">cross_patch_weight</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;cross_patch_weight&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for jackknife, etc. store the results of each pair of patches.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">rng</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
        <span class="n">Corr3</span><span class="o">.</span><span class="n">_lookup_dict</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_letters</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span>

    <span class="c1"># Properties for all the read-only attributes (&quot;ro&quot; stands for &quot;read-only&quot;)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_dots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">output_dots</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_log_sep_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_log_sep_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logr1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rnom1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bu</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bv</span>

    <span class="c1"># LogRUV:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rnom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">rnom</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logr</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ubin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vbin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nubins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">v1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">v</span>

    <span class="c1"># LogSAS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">d2nom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d2nom</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">d3nom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">d3nom</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logd2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd2</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logd3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LogSAS&#39;</span><span class="p">,</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">logd3</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_bin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nphi_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">phi_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_phi_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_phi_units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meanphi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span>

    <span class="c1"># LogMultipole:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_n</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">n1d</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">n</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_bintype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bintype</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_nbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_nbins</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_min_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_min_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_max_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_max_sep</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_bin_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">_bin_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">split_method</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_top</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_top</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_slop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">bin_slop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angle_slop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">angle_slop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">b</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">brute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">brute</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_rpar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_rpar</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_rpar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_rpar</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">xperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">yperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">zperiod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">var_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">var_method</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">num_bootstrap</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cross_patch_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">cross_patch_weight</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The estimated covariance matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cov_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A possibly more efficient way to access just the diagonal of the covariance matrix.</span>

<span class="sd">        If var_method == &#39;shot&#39;, then this won&#39;t make the full covariance matrix, just to</span>
<span class="sd">        then pull out the diagonal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builder</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bintype</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nubins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">ubin_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">min_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">max_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">nvbins</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ro</span><span class="o">.</span><span class="n">vbin_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_rpar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_rpar</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_zetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zetas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">zetas</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zetas</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">zetas</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">zetas</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
            <span class="n">zetas</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">zetas</span>

    <span class="k">def</span> <span class="nf">_equal_binning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">brief</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># A helper function to test if two Corr3 objects have the same binning parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_u</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_u</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_u</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nubins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nubins</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_v</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_v</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nvbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nvbins</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="c1"># LogSAS</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_phi</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_phi</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_phi</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nphi_bins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nphi_bins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># LogMultipole</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">min_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_sep</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_sep</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbins</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">max_n</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brief</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sep_units</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogSAS&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">phi_units</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bin_slop</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">angle_slop</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_rpar</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_rpar</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_rpar</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">max_rpar</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">xperiod</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">yperiod</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">zperiod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_equal_bin_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># A helper function to test if two Corr3 objects have the same measured bin values</span>
        <span class="n">equal_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand2</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meand3</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span> <span class="ow">and</span> <span class="n">equal_d</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanu</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanv</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span> <span class="ow">and</span> <span class="n">equal_d</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">meanphi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># LogMultipole</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span> <span class="ow">and</span> <span class="n">equal_d</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether two Correlation instances are equal&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_equal_binning</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_equal_bin_data</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>

<div class="viewcode-block" id="Corr3.copy"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="c1"># Only items that might change need to by deep copied.</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For everything else, shallow copy is fine.</span>
                <span class="c1"># In particular don&#39;t deep copy config or logger</span>
                <span class="c1"># Most of the rest are scalars, which copy fine this way.</span>
                <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">zi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># We&#39;ll want to make a new one of these if we need it.</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">make_minimal_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_valid_params</span><span class="p">)</span>
        <span class="n">kwargs_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">kwargs_str</span><span class="si">}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_corr&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_ok&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>     <span class="c1"># Remake this as needed.</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Oh well.  This is just lost in the copy.  Can&#39;t be pickled.</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_file&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>

<div class="viewcode-block" id="Corr3.clear"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all data vectors, the results dict, and any related values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_ok&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return if there are any values accumulated yet.  (i.e. ntri &gt; 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The lazy version when we can be sure the object isn&#39;t going to accumulate any more.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>

    <span class="k">def</span> <span class="nf">_add_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ijk</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
        <span class="c1"># No op for all but NNCorrelation, which needs to add the tot value</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_trivially_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">ordered</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">s1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">,</span><span class="n">s2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="n">z3</span><span class="p">,</span><span class="n">s3</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_get_center_size</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="o">.</span><span class="n">triviallyZero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">,</span>
                                       <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span>
                                       <span class="n">ordered</span><span class="p">,</span> <span class="p">(</span><span class="n">c2</span> <span class="ow">is</span> <span class="n">c3</span> <span class="ow">or</span> <span class="n">c1</span> <span class="ow">is</span> <span class="n">c2</span><span class="p">))</span>

    <span class="n">_make_expanded_patch</span> <span class="o">=</span> <span class="n">Corr2</span><span class="o">.</span><span class="n">_make_expanded_patch</span>

    <span class="k">def</span> <span class="nf">_single_process12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">ijj</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                          <span class="n">temp</span><span class="p">,</span> <span class="n">force_write</span><span class="p">):</span>
        <span class="c1"># Helper function for _process_all_auto, etc. for doing 12 cross pairs</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">c2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">ordered</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%s</span><span class="s1"> cross12&#39;</span><span class="p">,</span><span class="n">ijj</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                                 <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%s</span><span class="s1"> pair, which are too far apart &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">ijj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">or</span> <span class="n">force_write</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ijj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijj</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijj</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NNNCorrelation needs to add the tot value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">ijj</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_process21</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">iij</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                          <span class="n">temp</span><span class="p">,</span> <span class="n">force_write</span><span class="p">):</span>
        <span class="c1"># Helper function for _process_all_cross21, etc. for doing 21 cross pairs</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">c1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">ordered</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%s</span><span class="s1"> cross21&#39;</span><span class="p">,</span><span class="n">iij</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">process_cross21</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                                 <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%s</span><span class="s1"> pair, which are too far apart &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">iij</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">or</span> <span class="n">force_write</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iij</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">iij</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">iij</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">iij</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NNNCorrelation needs to add the tot value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">iij</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_process123</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">ijk</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                           <span class="n">temp</span><span class="p">,</span> <span class="n">force_write</span><span class="p">):</span>
        <span class="c1"># Helper function for _process_all_auto, etc. for doing 123 cross triples</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">c2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trivially_zero</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">ordered</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patches </span><span class="si">%s</span><span class="s1"> cross&#39;</span><span class="p">,</span><span class="n">ijk</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                               <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%s</span><span class="s1">, which are too far apart &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;for this set of separations&#39;</span><span class="p">,</span><span class="n">ijk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">or</span> <span class="n">force_write</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijk</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijk</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ijk</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NNNCorrelation needs to add the tot value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tot</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Now the tricky part.  If using MPI, we need to divide up the jobs smartly.</span>
            <span class="c1"># The first point is to divvy up the auto jobs evenly.  This is where most of the</span>
            <span class="c1"># work is done, so we want those to be spreads as evenly as possibly across procs.</span>
            <span class="c1"># Therefore, if all indices are mine, then do the job.</span>
            <span class="c1"># This reduces the number of catalogs this machine needs to load up.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If none of the indices are mine, then it&#39;s not my job.</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># When only one or two of the indices are mine, then we follow the same kind of</span>
            <span class="c1"># procedure as we did in 2pt.  There, we decided based on the parity of i.</span>
            <span class="c1"># Here that turns into i mod 3.</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">)</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_auto</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                        <span class="n">c1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_single_process12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c1e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                               <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                        <span class="n">temp</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> auto&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">temp</span><span class="o">.</span><span class="n">process_auto</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                                          <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>

                    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                                <span class="c1"># One point in c1, 2 in c2.</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_single_process12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="c1"># One point in c2, 2 in c1.</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_single_process12</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                            <span class="c1"># One point in each of c1, c2, c3</span>
                            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                                <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                        <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                                <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                        <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_cross12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                             <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If n1 is n, then this can be simple.  Just split according to i.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># If not, then this looks like the decision for 2pt auto using j,k.</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">k</span><span class="o">-</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_cross12</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span>
                                 <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires both catalogs use the same patches.&quot;</span><span class="p">)</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ordered1</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ordered</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                        <span class="n">c2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_single_process12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                               <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span><span class="p">:</span>
                    <span class="c1"># local method doesn&#39;t do unordered properly as is.</span>
                    <span class="c1"># It can only handle ordered=1 (or 3).</span>
                    <span class="c1"># So in this case, we need to repeat with c2 in the first spot.</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">):</span>
                            <span class="n">c1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="n">c2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> from cat2 with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c1e</span><span class="p">,</span> <span class="n">c2e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                        <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_single_process12</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span>
                                                   <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
                                                   <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="ow">or</span> <span class="n">n1</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
                        <span class="c1"># One point in each of c1, c2, c3</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered1</span><span class="p">,</span>
                                                        <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">kk</span> <span class="o">!=</span> <span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="c1"># Don&#39;t unload j+1, since that&#39;s the next one we&#39;ll need.</span>
                                    <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                        <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_cross21</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                             <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If n1 is n, then this can be simple.  Just split according to i.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># If not, then this looks like the decision for 2pt auto using j,k.</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">k</span><span class="o">-</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_indices</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_cross21</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span>
                                 <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires both catalogs use the same patches.&quot;</span><span class="p">)</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ordered3</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="p">(</span><span class="n">ordered</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                        <span class="n">c2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="n">c3e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2e</span><span class="p">,</span> <span class="n">c3e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                                                <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span> <span class="k">else</span> <span class="mi">4</span><span class="p">,</span>
                                                <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                        <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_single_process21</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span>
                                                   <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
                                                   <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">k</span> <span class="ow">or</span> <span class="n">n1</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
                        <span class="c1"># One point in each of c1, c2, c3</span>
                        <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered3</span><span class="p">,</span>
                                                        <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                                    <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                        <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_all_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                           <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">):</span>
            <span class="c1"># Helper function to figure out if a given (i,j,k) job should be done on the</span>
            <span class="c1"># current process.</span>

            <span class="c1"># Always my job if not using MPI.</span>
            <span class="k">if</span> <span class="n">my_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Just split up according to one of the catalogs.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">n2</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">my_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Job (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) is mine.&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_cross</span><span class="p">(</span><span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span>
                               <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When patch processing, keep track of the pair-wise results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="k">if</span> <span class="n">cat3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">npatch</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires all catalogs use the same patches.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cross correlation requires all catalogs use the same patches.&quot;</span><span class="p">)</span>

            <span class="c1"># Setup for deciding when this is my job.</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="n">n3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="k">if</span> <span class="n">comm</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">)</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rank</span> <span class="o">//</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: My indices are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">my_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_indices</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Convert bool into corresponding int</span>
            <span class="n">ordered</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">ordered</span>

            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">):</span>
                        <span class="n">c2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="n">c3e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2e</span><span class="p">,</span> <span class="n">c3e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                                                <span class="mi">1</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">,</span>
                                                <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                            <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ordered</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="c1"># local method doesn&#39;t do unordered properly as is.</span>
                    <span class="c1"># It can only handle ordered=1 or 4.</span>
                    <span class="c1"># So in this case, we need to repeat with c2 and c3 in the first spot.</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">):</span>
                            <span class="n">c1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="n">c3e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> from cat2 with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c1e</span><span class="p">,</span> <span class="n">c3e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                                                    <span class="mi">1</span> <span class="k">if</span> <span class="n">ordered</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">4</span><span class="p">,</span>
                                                    <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ordered</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat3</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">):</span>
                            <span class="n">c1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="n">c2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_expanded_patch</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process patch </span><span class="si">%d</span><span class="s1"> from cat3 with surrounding local patches&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">c2e</span><span class="p">,</span> <span class="n">c1e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                                                    <span class="mi">1</span> <span class="k">if</span> <span class="n">ordered</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">4</span><span class="p">,</span>
                                                    <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span>
                    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat2</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jj</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">c3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat3</span><span class="p">):</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="k">if</span> <span class="n">c3</span><span class="o">.</span><span class="n">_single_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kk</span>
                            <span class="k">if</span> <span class="n">is_my_job</span><span class="p">(</span><span class="n">my_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_single_process123</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span>
                                                        <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="o">==</span><span class="n">k</span> <span class="ow">or</span> <span class="n">n1</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">n3</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                                    <span class="n">c3</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">low_mem</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Don&#39;t unload i+1, since that&#39;s the next one we&#39;ll need.</span>
                            <span class="n">c2</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">low_mem</span><span class="p">:</span>
                        <span class="n">c1</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2">: Completed jobs </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Send all the results back to rank 0 process.</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span> <span class="o">+=</span> <span class="n">temp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

<div class="viewcode-block" id="Corr3.getStat"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.getStat">[docs]</a>    <span class="k">def</span> <span class="nf">getStat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The standard statistic for the current correlation object as a 1-d array.</span>

<span class="sd">        Usually, this is just self.zeta.  But in case we have a multi-dimensional array</span>
<span class="sd">        at some point (like TwoD for 2pt), use self.zeta.ravel().</span>

<span class="sd">        And for `GGGCorrelation`, it is the concatenation of the four different correlations</span>
<span class="sd">        [gam0.ravel(), gam1.ravel(), gam2.ravel(), gam3.ravel()].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>

<div class="viewcode-block" id="Corr3.getWeight"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.getWeight">[docs]</a>    <span class="k">def</span> <span class="nf">getWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The weight array for the current correlation object as a 1-d array.</span>

<span class="sd">        This is the weight array corresponding to `getStat`. Usually just self.weight.ravel(),</span>
<span class="sd">        but duplicated for GGGCorrelation to match what `getStat` does in that case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For most bin types, this is just the normal weight.</span>
        <span class="c1"># but for LogMultipole, the absolute value is what we want.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span></div>

<div class="viewcode-block" id="Corr3.process_auto"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.process_auto">[docs]</a>    <span class="k">def</span> <span class="nf">process_auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single catalog, accumulating the auto-correlation.</span>

<span class="sd">        This accumulates the auto-correlation for the given catalog.  After</span>
<span class="sd">        calling this function as often as desired, the ``finalize`` command will</span>
<span class="sd">        finish the calculation of meand1, meanlogd1, etc.</span>

<span class="sd">        This method is only valid for classes that have the same type of value in all</span>
<span class="sd">        three triangle vertices.  (E.g. NNN, GGG, KKK)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat (Catalog):      The catalog to process</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            corr_only (bool):   Whether to skip summing quantities that are not essential for</span>
<span class="sd">                                computing the correlation function. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The implementation is the same for all classes that can call this.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span>
        <span class="k">if</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="si">}</span><span class="s1"> auto-correlations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="si">}</span><span class="s1"> auto-correlations for cat %s.&#39;</span><span class="p">,</span>
                             <span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="n">corr_only</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">getField</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">getField</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                         <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span> <span class="n">brute</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span><span class="p">),</span>
                         <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                         <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">field</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="o">.</span><span class="n">processAuto</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">corr_only</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.process_cross12"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.process_cross12">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">corr_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process two catalogs, accumulating the 3pt cross-correlation, where one of the</span>
<span class="sd">        points in each triangle come from the first catalog, and two come from the second.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs as part of a larger</span>
<span class="sd">        auto- or cross-correlation calculation.  E.g. when splitting up a large catalog into</span>
<span class="sd">        patches, this is appropriate to use for the cross correlation between different patches</span>
<span class="sd">        as part of the complete auto-correlation of the full catalog.</span>

<span class="sd">        This method is only valid for classes that have the same type of value in vertices</span>
<span class="sd">        2 and 3.  (E.g. KKK, KGG, NKK)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process. (1 point in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process. (2 points in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            ordered (bool):     Whether to fix the order of the triangle vertices to match the</span>
<span class="sd">                                catalogs. (default: True)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            corr_only (bool):   Whether to skip summing quantities that are not essential for</span>
<span class="sd">                                computing the correlation function. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> (1-2) cross-correlations&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> (1-2) cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="n">corr_only</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">getField1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">getField2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">getField1</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">getField2</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="n">ocode</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="o">.</span><span class="n">processCross12</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ocode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                                 <span class="nb">bool</span><span class="p">(</span><span class="n">corr_only</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.process_cross21"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.process_cross21">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross21</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">corr_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process two catalogs, accumulating the 3pt cross-correlation, where two of the</span>
<span class="sd">        points in each triangle come from the first catalog, and one comes from the second.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs as part of a larger</span>
<span class="sd">        auto- or cross-correlation calculation.  E.g. when splitting up a large catalog into</span>
<span class="sd">        patches, this is appropriate to use for the cross correlation between different patches</span>
<span class="sd">        as part of the complete auto-correlation of the full catalog.</span>

<span class="sd">        This method is only valid for classes that have the same type of value in vertices</span>
<span class="sd">        1 and 2.  (E.g. KKK, KKG, NNK)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process. (2 points in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process. (1 point in each triangle will come</span>
<span class="sd">                                from this catalog.)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            ordered (bool):     Whether to fix the order of the triangle vertices to match the</span>
<span class="sd">                                catalogs. (default: True)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            corr_only (bool):   Whether to skip summing quantities that are not essential for</span>
<span class="sd">                                computing the correlation function. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> (2-1) cross-correlations&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> (2-1) cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="n">corr_only</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">getField1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">getField2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">getField1</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">getField2</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="n">ocode</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="o">.</span><span class="n">processCross21</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ocode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                                 <span class="nb">bool</span><span class="p">(</span><span class="n">corr_only</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.process_cross"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.process_cross">[docs]</a>    <span class="k">def</span> <span class="nf">process_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">corr_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a set of three catalogs, accumulating the 3pt cross-correlation.</span>

<span class="sd">        This accumulates the cross-correlation for the given catalogs as part of a larger</span>
<span class="sd">        auto- or cross-correlation calculation.  E.g. when splitting up a large catalog into</span>
<span class="sd">        patches, this is appropriate to use for the cross correlation between different patches</span>
<span class="sd">        as part of the complete auto-correlation of the full catalog.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     The first catalog to process</span>
<span class="sd">            cat2 (Catalog):     The second catalog to process</span>
<span class="sd">            cat3 (Catalog):     The third catalog to process</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            ordered (bool):     Whether to fix the order of the triangle vertices to match the</span>
<span class="sd">                                catalogs. (default: True)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            corr_only (bool):   Whether to skip summing quantities that are not essential for</span>
<span class="sd">                                computing the correlation function. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> cross-correlations&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting process </span><span class="si">%s</span><span class="s1"> cross-correlations for cats </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat2</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">cat3</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="n">corr_only</span>
        <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minmax_size</span><span class="p">()</span>

        <span class="n">getField1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">getField2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">getField3</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;get</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="si">}</span><span class="s2">Field&quot;</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">getField1</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">getField2</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">getField3</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                       <span class="n">split_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_method</span><span class="p">,</span>
                       <span class="n">brute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">brute</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
                       <span class="n">min_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_top</span><span class="p">,</span> <span class="n">max_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_top</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting </span><span class="si">%d</span><span class="s1"> jobs.&#39;</span><span class="p">,</span><span class="n">f1</span><span class="o">.</span><span class="n">nTopLevelNodes</span><span class="p">)</span>
        <span class="n">ocode</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="n">ordered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="o">.</span><span class="n">processCross</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ocode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dots</span><span class="p">,</span>
                               <span class="nb">bool</span><span class="p">(</span><span class="n">corr_only</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.process"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cat3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">patch_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corr_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the 3pt correlation function.</span>

<span class="sd">        - If only 1 argument is given, then compute an auto-correlation function.</span>
<span class="sd">        - If 2 arguments are given, then compute a cross-correlation function with the</span>
<span class="sd">          first catalog taking one corner of the triangles, and the second taking two corners.</span>
<span class="sd">        - If 3 arguments are given, then compute a three-way cross-correlation function.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For cross correlations where the third field type is different from the other two</span>
<span class="sd">            (e.g. KKG, NNG, etc.) then the 2 argument version will use the first catalog</span>
<span class="sd">            for first two vertices and the second for the third vertex, since that&#39;s the</span>
<span class="sd">            only valid combination for those correlation types.</span>

<span class="sd">            E.g. ``kkg.process(cat1, cat2)`` is equivalent to ``kkg.process(cat1, cat1, cat2)``,</span>
<span class="sd">            except it will be slightly more efficient, since it knows the first two vertices</span>
<span class="sd">            are from a single field.</span>

<span class="sd">        For cross correlations, the default behavior is to use cat1 for the first vertex (P1),</span>
<span class="sd">        cat2 for the second vertex (P2), and cat3 for the third vertex (P3).  If only two</span>
<span class="sd">        catalogs are given, vertices P2 and P3 both come from cat2.  The sides d1, d2, d3,</span>
<span class="sd">        used to define the binning, are taken to be opposte P1, P2, P3 respectively.</span>

<span class="sd">        However, if you want to accumulate triangles where objects from each catalog can take</span>
<span class="sd">        any position in the triangles, you can set ``ordered=False``.  In this case,</span>
<span class="sd">        triangles will be formed where P1, P2 and P3 can come any input catalog, so long as there</span>
<span class="sd">        is one from cat1, one from cat2, and one from cat3 (or two from cat2 if cat3 is None).</span>

<span class="sd">        All arguments may be lists, in which case all items in the list are used</span>
<span class="sd">        for that element of the correlation.</span>

<span class="sd">        .. note::</span>

<span class="sd">            In addition to ordered = True or False, you may also set ordered to 1, 2 or 3</span>
<span class="sd">            which means that the catalog in that position is fixed, but the other two</span>
<span class="sd">            vertices are unordered.  E.g. if ordered=3, then P3 will always come from cat3,</span>
<span class="sd">            but P1 and P2 will each come from one of cat1 or cat2 in either order.</span>
<span class="sd">            This option is only valid when all three catalogs (cat1, cat2, cat3) are given.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cat1 (Catalog):     A catalog or list of catalogs for the first field.</span>
<span class="sd">            cat2 (Catalog):     A catalog or list of catalogs for the second field.</span>
<span class="sd">                                (default: None)</span>
<span class="sd">            cat3 (Catalog):     A catalog or list of catalogs for the third field.</span>
<span class="sd">                                (default: None)</span>
<span class="sd">            metric (str):       Which metric to use.  See `Metrics` for details.</span>
<span class="sd">                                (default: &#39;Euclidean&#39;; this value can also be given in the</span>
<span class="sd">                                constructor in the config dict.)</span>
<span class="sd">            ordered (bool):     Whether to fix the order of the triangle vertices to match the</span>
<span class="sd">                                catalogs. (see above; default: True)</span>
<span class="sd">            num_threads (int):  How many OpenMP threads to use during the calculation.</span>
<span class="sd">                                (default: use the number of cpu cores; this value can also be given</span>
<span class="sd">                                in the constructor in the config dict.)</span>
<span class="sd">            comm (mpi4py.Comm): If running MPI, an mpi4py Comm object to communicate between</span>
<span class="sd">                                processes.  If used, the rank=0 process will have the final</span>
<span class="sd">                                computation. This only works if using patches. (default: None)</span>
<span class="sd">            low_mem (bool):     Whether to sacrifice a little speed to try to reduce memory usage.</span>
<span class="sd">                                This only works if using patches. (default: False)</span>
<span class="sd">            initialize (bool):  Whether to begin the calculation with a call to</span>
<span class="sd">                                `Corr3.clear`.  (default: True)</span>
<span class="sd">            finalize (bool):    Whether to complete the calculation with a call to finalize.</span>
<span class="sd">                                (default: True)</span>
<span class="sd">            patch_method (str): Which patch method to use. (default is to use &#39;local&#39; if</span>
<span class="sd">                                bin_type=LogMultipole, and &#39;global&#39; otherwise)</span>
<span class="sd">            algo (str):         Which accumulation algorithm to use. (options are &#39;triangle&#39; or</span>
<span class="sd">                                &#39;multipole&#39;; default is &#39;multipole&#39; unless bin_type is &#39;LogRUV&#39;,</span>
<span class="sd">                                which can only use &#39;triangle&#39;)</span>
<span class="sd">            max_n (int):        If using the multpole algorithm, and this is not directly using</span>
<span class="sd">                                bin_type=&#39;LogMultipole&#39;, then this is the value of max_n to use</span>
<span class="sd">                                for the multipole part of the calculation. (default is to use</span>
<span class="sd">                                2pi/phi_bin_size; this value can also be given in the constructor</span>
<span class="sd">                                in the config dict.)</span>
<span class="sd">            corr_only (bool):   Whether to skip summing quantities that are not essential for</span>
<span class="sd">                                computing the correlation function. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">math</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">multipole</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">algo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="s1">&#39;multipole&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid algo </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">algo</span><span class="p">)</span>
            <span class="n">multipole</span> <span class="o">=</span> <span class="p">(</span><span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;multipole&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">multipole</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LogRUV binning cannot use algo=&#39;multipole&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multipole</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LogMultipole&#39;</span>
            <span class="k">if</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">max_n</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_bin_size</span>
                <span class="c1"># If max_n was given in constructor, use that instead.</span>
                <span class="n">max_n</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_n&#39;</span><span class="p">,</span> <span class="n">max_n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;max_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;nphi_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_bin_size&#39;</span><span class="p">]:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span>
                         <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                         <span class="n">corr_only</span><span class="o">=</span><span class="n">corr_only</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">,</span>
                         <span class="n">initialize</span><span class="o">=</span><span class="n">initialize</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="n">finalize</span><span class="p">,</span>
                         <span class="n">patch_method</span><span class="o">=</span><span class="n">patch_method</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;multipole&#39;</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">toSAS</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">corr_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meanwww</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">patch_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">patch_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid patch_method </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">patch_method</span><span class="p">)</span>
            <span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch_method</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LogMultipole binning cannot use patch_method=&#39;global&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">cat1</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">get_patches</span><span class="p">(</span><span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">cat2</span> <span class="o">=</span> <span class="n">cat2</span><span class="o">.</span><span class="n">get_patches</span><span class="p">(</span><span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">cat3</span> <span class="o">=</span> <span class="n">cat3</span><span class="o">.</span><span class="n">get_patches</span><span class="p">(</span><span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span> <span class="o">=</span> <span class="n">corr_only</span>

        <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> cannot use one catalog version of process&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For two catalog case, use cat1,cat2, not cat1,cat3&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ordered</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The integer options for ordered are only valid with 3 catalogs&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_auto</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ordered</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">ordered</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The integer options for ordered are only valid with 3 catalogs&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross12</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                                          <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross21</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                                          <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> cannot use two catalog version of process&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_cross</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">,</span>
                                    <span class="n">comm</span><span class="p">,</span> <span class="n">low_mem</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">var1</span> <span class="o">=</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">var3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar1</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig1</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">var1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">:</span>
                    <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar1</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="n">var2</span> <span class="o">=</span> <span class="n">var3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar2</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">var1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s1 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig1</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">var2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s2 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig2</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span>
                    <span class="n">var1</span> <span class="o">=</span> <span class="n">var2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar1</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="n">var3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar3</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">var1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s1 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig1</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">var3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s2 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig2</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">,</span> <span class="n">var3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var3</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar1</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="n">var2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar2</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="n">var3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateVar3</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s1 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig1</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">var2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s2 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig2</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">var3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;var%s3 = %f: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sig3</span><span class="si">}</span><span class="s2"> = %f&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">,</span> <span class="n">var3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">corr_only</span><span class="p">:</span>
                <span class="n">w1</span> <span class="o">=</span> <span class="n">calculateMeanW</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cat2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">w2</span> <span class="o">=</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">w1</span>
                <span class="k">elif</span> <span class="n">cat3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">w2</span> <span class="o">=</span> <span class="n">calculateMeanW</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">:</span>
                        <span class="n">w3</span> <span class="o">=</span> <span class="n">w2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">w3</span> <span class="o">=</span> <span class="n">w1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w2</span> <span class="o">=</span> <span class="n">calculateMeanW</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                    <span class="n">w3</span> <span class="o">=</span> <span class="n">calculateMeanW</span><span class="p">(</span><span class="n">cat3</span><span class="p">,</span> <span class="n">low_mem</span><span class="o">=</span><span class="n">low_mem</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meanwww</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="o">*</span><span class="n">w3</span>

            <span class="n">finalize_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="o">*</span><span class="n">finalize_args</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logd2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logd3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="o">**</span><span class="mi">2</span>
                                          <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meanwww</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>

            <span class="c1"># Update the units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_units</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span>

            <span class="c1"># Set to nominal when no triangles in bin.</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logr</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logd2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logd3</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                                                 <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span><span class="o">*</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">mask2</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
                <span class="c1"># Multipole only sets the meand values at [i,j,max_n].</span>
                <span class="c1"># (This is also where the complex weight is just a scalar = sum(www),</span>
                <span class="c1"># so the above normalizations are correct.)</span>
                <span class="c1"># Broadcast those to the rest of the values in the third dimension.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">][:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">][:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">][:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">][:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">][:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the data vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varzeta</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a second Correlation object&#39;s data to this one.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For this to make sense, both objects should not have had ``finalize`` called yet.</span>
<span class="sd">            Then, after adding them together, you should call ``finalize`` on the sum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can only add another </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="si">}</span><span class="s2"> object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equal_binning</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">brief</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="si">}</span><span class="s2"> to be added is not compatible with this one.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">nonzero</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">meanv</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">weightr</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">weighti</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">):</span>
        <span class="c1"># Equivalent to the operation of:</span>
        <span class="c1">#     self._clear()</span>
        <span class="c1">#     for other,w in others:</span>
        <span class="c1">#         self += w*other</span>
        <span class="c1"># if w*other was valid syntax, which it isn&#39;t.</span>

        <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">a</span><span class="o">*</span><span class="n">w</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">weightr</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">weighti</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">corr_only</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">meanv</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meanv</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ntri</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">others</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varzeta</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_calculate_varzeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varzeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varzeta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_diag</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_nbins</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_nbins</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>

    <span class="k">def</span> <span class="nf">_x_to_natural_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zetas</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;VGTQ&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Now fix the projection.</span>
            <span class="c1"># The multipole algorithm uses the Porth et al x projection.</span>
            <span class="c1"># We need to switch that to the canoical centroid projection.</span>

            <span class="c1"># (Comments here are for GGG, but we can use this for any class</span>
            <span class="c1"># that has at least one non-spin 0 value needing a projection.)</span>

            <span class="c1"># Define some complex &quot;vectors&quot; where p1 is at the origin and</span>
            <span class="c1"># p3 is on the x axis:</span>
            <span class="c1"># s = p3 - p1</span>
            <span class="c1"># t = p2 - p1</span>
            <span class="c1"># u = angle bisector of s, t</span>
            <span class="c1"># q1 = (s+t)/3.  (this is the centroid)</span>
            <span class="c1"># q2 = q1-t</span>
            <span class="c1"># q3 = q1-s</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="n">q1</span><span class="o">-</span><span class="n">t</span>
            <span class="n">q3</span> <span class="o">=</span> <span class="n">q1</span><span class="o">-</span><span class="n">s</span>

            <span class="c1"># Currently the projection is as follows:</span>
            <span class="c1"># g1 is projected along u</span>
            <span class="c1"># g2 is projected along t</span>
            <span class="c1"># g3 is projected along s</span>
            <span class="c1">#</span>
            <span class="c1"># We want to have</span>
            <span class="c1"># g1 projected along q1</span>
            <span class="c1"># g2 projected along q2</span>
            <span class="c1"># g3 projected along q3</span>
            <span class="c1">#</span>
            <span class="c1"># The phases to multiply by are exp(2iphi_current) * exp(-2iphi_target). I.e.</span>
            <span class="c1"># g1phase = (u conj(q1))**2 / |u conj(q1)|**2</span>
            <span class="c1"># g2phase = (t conj(q2))**2 / |t conj(q2)|**2</span>
            <span class="c1"># g3phase = (s conj(q3))**2 / |s conj(q3)|**2</span>
            <span class="n">g1phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">q1</span><span class="p">))</span><span class="o">**</span><span class="n">spin_by_letter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span><span class="p">)</span>
            <span class="n">g2phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">q2</span><span class="p">))</span><span class="o">**</span><span class="n">spin_by_letter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter2</span><span class="p">)</span>
            <span class="n">g3phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">q3</span><span class="p">))</span><span class="o">**</span><span class="n">spin_by_letter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter3</span><span class="p">)</span>
            <span class="n">g1phase</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g1phase</span><span class="p">)</span>
            <span class="n">g2phase</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g2phase</span><span class="p">)</span>
            <span class="n">g3phase</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g3phase</span><span class="p">)</span>

            <span class="c1"># Now just multiply each gam by the appropriate combination of phases.</span>
            <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g1phase</span> <span class="o">*</span> <span class="n">g2phase</span> <span class="o">*</span> <span class="n">g3phase</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zetas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">g1phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">g2phase</span> <span class="o">*</span> <span class="n">g3phase</span>
                <span class="n">phases</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">g1phase</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">g2phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">g3phase</span>
                <span class="n">phases</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">g1phase</span> <span class="o">*</span> <span class="n">g2phase</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">g3phase</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zetas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># This one is a little tricky.  It means there are two spinny vertices.</span>
                <span class="c1"># If letter1 is N or K, then the conjugate is vertex 2</span>
                <span class="c1"># otherwise it is vertex 1.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter1</span> <span class="ow">in</span> <span class="s1">&#39;NK&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">g1phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">g2phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">g3phase</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">g1phase</span><span class="p">)</span> <span class="o">*</span> <span class="n">g2phase</span> <span class="o">*</span> <span class="n">g3phase</span>
        <span class="k">return</span> <span class="n">phases</span>

<div class="viewcode-block" id="Corr3.toSAS"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.toSAS">[docs]</a>    <span class="k">def</span> <span class="nf">toSAS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a multipole-binned correlation to the corresponding SAS binning.</span>

<span class="sd">        This is only valid for bin_type == LogMultipole.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            target:     A target Correlation object with LogSAS binning to write to.</span>
<span class="sd">                        If this is not given, a new object will be created based on the</span>
<span class="sd">                        configuration paramters of the current object. (default: None)</span>
<span class="sd">            **kwargs:   Any kwargs that you want to use to configure the returned object.</span>
<span class="sd">                        Typically, might include min_phi, max_phi, nphi_bins, phi_bin_size.</span>
<span class="sd">                        The default phi binning is [0,pi] with nphi_bins = self.max_n.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An object with bin_type=LogSAS containing the same information as this object,</span>
<span class="sd">            but with the SAS binning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Each class will add a bit to this.  The implemenation here is the common code</span>
        <span class="c1"># that applies to all the different classes.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;toSAS is invalid for bin_type = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LogSAS&#39;</span>
            <span class="n">max_n</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_n&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;nphi_bins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;phi_bin_size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;nphi_bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_n</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target must be an instance of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">target</span>
            <span class="n">sas</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">rnom1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom1d</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;toSAS cannot change sep parameters&quot;</span><span class="p">)</span>

        <span class="c1"># Copy these over</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">][:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">][:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">][:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">][:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">_var_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_num</span>

        <span class="c1"># Use nominal for meanphi</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meanu</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi</span> <span class="o">/</span> <span class="n">sas</span><span class="o">.</span><span class="n">_phi_units</span>
        <span class="c1"># Compute d1 from actual d2,d3 and nominal phi</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meand1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">meand2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sas</span><span class="o">.</span><span class="n">meand3</span><span class="o">**</span><span class="mi">2</span>
                                <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sas</span><span class="o">.</span><span class="n">meand2</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">meand3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">meand1</span><span class="p">)</span>

        <span class="c1"># Eqn 26 of Porth et al, 2023</span>
        <span class="c1"># N(d2,d3,phi) = 1/2pi sum_n N_n(d2,d3) exp(i n phi)</span>
        <span class="n">expiphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1d</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi1d</span><span class="p">)</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">weightr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expiphi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi_bin_size</span>

        <span class="c1"># For ntri, we recorded the total ntri for each pair of d2,d3.</span>
        <span class="c1"># Allocate those proportionally to the weights.</span>
        <span class="c1"># Note: Multipole counts the weight for all 0 &lt; phi &lt; 2pi.</span>
        <span class="c1"># We reduce this by the fraction of this covered by [min_phi, max_phi].</span>
        <span class="c1"># (Typically 1/2, since usually [0,pi].)</span>
        <span class="n">phi_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">max_phi</span> <span class="o">-</span> <span class="n">sas</span><span class="o">.</span><span class="n">min_phi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">denom</span><span class="p">[</span><span class="n">denom</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Don&#39;t divide by 0</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span> <span class="o">*</span> <span class="n">phi_frac</span>
        <span class="n">sas</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expiphi</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi_bin_size</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">ntri</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span>

            <span class="c1"># Undo the normalization of the d arrays.</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meand1</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meand2</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meand3</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">meanu</span> <span class="o">*=</span> <span class="n">temp</span><span class="o">.</span><span class="n">weightr</span>

            <span class="n">sas</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># NNN doesn&#39;t have a zeta to compute</span>
            <span class="k">return</span> <span class="n">sas</span>

        <span class="c1"># Z(d2,d3,phi) = 1/2pi sum_n Z_n(d2,d3) exp(i n phi)</span>
        <span class="n">expiphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n1d</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi1d</span><span class="p">)</span>

        <span class="n">zetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expiphi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi_bin_size</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zetas</span><span class="p">]</span>

        <span class="c1"># We leave the gam_mu unnormalized in the Multipole class, so after the FT,</span>
        <span class="c1"># we still need to divide by weight.</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">weightr</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zetas</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="n">sas</span><span class="o">.</span><span class="n">weightr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">_x_to_natural_phases</span><span class="p">()</span>
        <span class="n">zetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">*</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z</span> <span class="k">for</span> <span class="n">z</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zetas</span><span class="p">,</span> <span class="n">phases</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zetas</span><span class="p">)):</span>
            <span class="n">sas</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">zetas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="c1"># KKK for instance has real zeta, so no z[1]</span>
                <span class="n">sas</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">zetas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">zetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expiphi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sas</span><span class="o">.</span><span class="n">phi_bin_size</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">_zetas</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zetas</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">zetas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">temp</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">zetas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">zetas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">sas</span></div>

<div class="viewcode-block" id="Corr3.estimate_cov"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.estimate_cov">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_bootstrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">cross_patch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate the covariance matrix based on the data</span>

<span class="sd">        This function will calculate an estimate of the covariance matrix according to the</span>
<span class="sd">        given method.</span>

<span class="sd">        Options for ``method`` include:</span>

<span class="sd">            - &#39;shot&#39; = The variance based on &quot;shot noise&quot; only.  This includes the Poisson</span>
<span class="sd">              counts of points for N statistics, shape noise for G statistics, and the observed</span>
<span class="sd">              scatter in the values for K statistics.  In this case, the returned value will</span>
<span class="sd">              only be the diagonal.  Use np.diagonal(cov) if you actually want a full</span>
<span class="sd">              matrix from this.</span>
<span class="sd">            - &#39;jackknife&#39; = A jackknife estimate of the covariance matrix based on the scatter</span>
<span class="sd">              in the measurement when excluding one patch at a time.</span>
<span class="sd">            - &#39;sample&#39; = An estimate based on the sample covariance of a set of samples,</span>
<span class="sd">              taken as the patches of the input catalog.</span>
<span class="sd">            - &#39;bootstrap&#39; = A bootstrap covariance estimate. It selects patches at random with</span>
<span class="sd">              replacement and then generates the statistic using all the auto-correlations at</span>
<span class="sd">              their selected repetition plus all the cross terms that aren&#39;t actually auto terms.</span>
<span class="sd">            - &#39;marked_bootstrap&#39; = An estimate based on a marked-point bootstrap resampling of the</span>
<span class="sd">              patches.  Similar to bootstrap, but only samples the patches of the first catalog and</span>
<span class="sd">              uses all patches from the second catalog that correspond to each patch selection of</span>
<span class="sd">              the first catalog.  cf. https://ui.adsabs.harvard.edu/abs/2008ApJ...681..726L/</span>

<span class="sd">        Both &#39;bootstrap&#39; and &#39;marked_bootstrap&#39; use the num_bootstrap parameter, which can be set on</span>
<span class="sd">        construction.</span>

<span class="sd">        Another relevant parameter is &#39;cross_patch_weight&#39;. This parameter controls how</span>
<span class="sd">        triangles that cross between two or three patches are weighted when some, but not all</span>
<span class="sd">        of the patches are selected.  See Mohammad and Percival (2021)</span>
<span class="sd">        (https://arxiv.org/abs/2109.07071) for an in-depth discussion of these options for</span>
<span class="sd">        two-point statistics.  We use a similar definitions for three-point statistics.</span>
<span class="sd">        Briefly the options are: (TODO!  This is aspirational so far.)</span>

<span class="sd">            - &#39;simple&#39; = Don&#39;t use any triangles where any object is in a deselected patch.</span>
<span class="sd">              This is currently the default for all methods.</span>
<span class="sd">            - &#39;mean&#39; = Use a weight of 1/3 for any triangle with one object in a selected patch</span>
<span class="sd">              and the other two in deselected patches, and 2/3 for any triangle with two objects</span>
<span class="sd">              in selected patches.</span>
<span class="sd">            - &#39;geom&#39; = Use the geometric mean of the three patch weights for each triangle.</span>
<span class="sd">            - &#39;match&#39; = Use the &quot;optimal&quot; weight that matches the effect of auto- and cross-pairs</span>
<span class="sd">              for two-point jackknife covariances derived by Mohammad and Percival</span>
<span class="sd">              (w = n_patch / (2 + sqrt(2) (n_patch-1))).</span>
<span class="sd">              There is a similar formula for triangles that span three different patches</span>
<span class="sd">              (w = sqrt(2) n_patch / 3 (n_patch - 1 + sqrt(2))), which we use for those triples.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For most classes, there is only a single statistic, ``zeta``, so this calculates a</span>
<span class="sd">            covariance matrix for that vector.  `GGGCorrelation` has four: ``gam0``, ``gam1``,</span>
<span class="sd">            ``gam2``, and ``gam3``, so in this case the full data vector is ``gam0`` followed by</span>
<span class="sd">            ``gam1``, then ``gam2``, then ``gam3``, and this calculates the covariance matrix for</span>
<span class="sd">            that full vector including both statistics.  The helper function `getStat` returns the</span>
<span class="sd">            relevant statistic in all cases.</span>

<span class="sd">        In all cases, the relevant processing needs to already have been completed and finalized.</span>
<span class="sd">        And for all methods other than &#39;shot&#39;, the processing should have involved an appropriate</span>
<span class="sd">        number of patches -- preferably more patches than the length of the vector for your</span>
<span class="sd">        statistic, although this is not checked.</span>

<span class="sd">        The default data vector to use for the covariance matrix is given by the method</span>
<span class="sd">        `getStat`.  As noted above, this is usually just self.zeta.  However, there is an option</span>
<span class="sd">        to compute the covariance of some other function of the correlation object by providing</span>
<span class="sd">        an arbitrary function, ``func``, which should act on the current correlation object</span>
<span class="sd">        and return the data vector of interest.</span>

<span class="sd">        For instance, for an `GGGCorrelation`, you might want to compute the covariance of just</span>
<span class="sd">        gam0 and ignore the others.  In this case you could use</span>

<span class="sd">            &gt;&gt;&gt; func = lambda ggg: ggg.gam0</span>

<span class="sd">        The return value from this func should be a single numpy array. (This is not directly</span>
<span class="sd">        checked, but you&#39;ll probably get some kind of exception if it doesn&#39;t behave as expected.)</span>

<span class="sd">        .. note::</span>

<span class="sd">            The optional ``func`` parameter is not valid in conjunction with ``method=&#39;shot&#39;``.</span>
<span class="sd">            It only works for the methods that are based on patch combinations.</span>

<span class="sd">        This function can be parallelized by passing the comm argument as an mpi4py communicator</span>
<span class="sd">        to parallelize using that.  For MPI, all processes should have the same inputs.</span>
<span class="sd">        If method == &quot;shot&quot; then parallelization has no effect.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method (str):       Which method to use to estimate the covariance matrix.</span>
<span class="sd">            func (function):    A unary function that acts on the current correlation object and</span>
<span class="sd">                                returns the desired data vector. (default: None, which is</span>
<span class="sd">                                equivalent to ``lambda corr: corr.getStat()``)</span>
<span class="sd">            comm (mpi comm)     If not None, run under MPI (default: None)</span>
<span class="sd">            num_bootstrap (int): How many bootstrap samples to use for the &#39;bootstrap&#39; and</span>
<span class="sd">                                &#39;marked_bootstrap&#39; var_methods.  (default: 500; this value</span>
<span class="sd">                                can also be given in the constructor.)</span>
<span class="sd">            cross_patch_weight (str): How to weight pairs that cross between two patches when one</span>
<span class="sd">                                patch is deselected (e.g. in a jackknife sense) and the other is</span>
<span class="sd">                                selected.  (default &#39;simple&#39;; this value can also be given in</span>
<span class="sd">                                the constructor.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A numpy array with the estimated covariance matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_bootstrap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_bootstrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bootstrap</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Need to convert it to a function of the first item in the list.</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">corrs</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">corrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">estimate_multi_cov</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">all_func</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span>
                                  <span class="n">num_bootstrap</span><span class="o">=</span><span class="n">num_bootstrap</span><span class="p">,</span>
                                  <span class="n">cross_patch_weight</span><span class="o">=</span><span class="n">cross_patch_weight</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.build_cov_design_matrix"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.build_cov_design_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">build_cov_design_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_bootstrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">cross_patch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build the design matrix that is used for estimating the covariance matrix.</span>

<span class="sd">        The design matrix for patch-based covariance estimates is a matrix where each row</span>
<span class="sd">        corresponds to a different estimate of the data vector, :math:`\zeta_i` (or</span>
<span class="sd">        :math:`f(\zeta_i)` if using the optional ``func`` parameter).</span>

<span class="sd">        The different of rows in the matrix for each valid ``method`` are:</span>

<span class="sd">            - &#39;shot&#39;: This method is not valid here.</span>
<span class="sd">            - &#39;jackknife&#39;: The data vector when excluding a single patch.</span>
<span class="sd">            - &#39;sample&#39;: The data vector using only a single patch for the first catalog.</span>
<span class="sd">            - &#39;bootstrap&#39;: The data vector for a random resampling of the patches keeping the</span>
<span class="sd">              sample total number, but allowing some to repeat.  Cross terms from repeated patches</span>
<span class="sd">              are excluded (since they are really auto terms).</span>
<span class="sd">            - &#39;marked_bootstrap&#39;: The data vector for a random resampling of patches in the first</span>
<span class="sd">              catalog, using all patches for the second catalog.  Based on the algorithm in</span>
<span class="sd">              Loh(2008).</span>

<span class="sd">        See `estimate_cov` for more details.</span>

<span class="sd">        The return value includes both the design matrix and a vector of weights (the total weight</span>
<span class="sd">        array in the computed correlation functions).  The weights are used for the sample method</span>
<span class="sd">        when estimating the covariance matrix.  The other methods ignore them, but they are provided</span>
<span class="sd">        here in case they are useful.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method (str):       Which method to use to estimate the covariance matrix.</span>
<span class="sd">            func (function):    A unary function that takes the list ``corrs`` and returns the</span>
<span class="sd">                                desired full data vector. (default: None, which is equivalent to</span>
<span class="sd">                                ``lambda corrs: np.concatenate([c.getStat() for c in corrs])``)</span>
<span class="sd">            comm (mpi comm)     If not None, run under MPI (default: None)</span>
<span class="sd">            num_bootstrap (int): How many bootstrap samples to use for the &#39;bootstrap&#39; and</span>
<span class="sd">                                &#39;marked_bootstrap&#39; var_methods.  (default: 500; this value</span>
<span class="sd">                                can also be given in the constructor.)</span>
<span class="sd">            cross_patch_weight (str): How to weight pairs that cross between two patches when one</span>
<span class="sd">                                patch is deselected (e.g. in a jackknife sense) and the other is</span>
<span class="sd">                                selected.  (default &#39;simple&#39;; this value can also be given in the</span>
<span class="sd">                                constructor.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A, w: numpy arrays with the design matrix and weights respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_bootstrap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_bootstrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bootstrap</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Need to convert it to a function of the first item in the list.</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">corrs</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">corrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">build_multi_cov_design_matrix</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">all_func</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span>
                                             <span class="n">num_bootstrap</span><span class="o">=</span><span class="n">num_bootstrap</span><span class="p">,</span>
                                             <span class="n">cross_patch_weight</span><span class="o">=</span><span class="n">cross_patch_weight</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_num_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_threads&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Set num_threads automatically from ncpu&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Set num_threads = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="n">set_omp_threads</span><span class="p">(</span><span class="n">num_threads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords3</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;Euclidean&#39;</span><span class="p">)</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">parse_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">,</span> <span class="n">coords3</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">,</span> <span class="n">coords3</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_rpar</span> <span class="o">!=</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min_rpar is only valid for 3d coordinates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_rpar</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_rpar is only valid for 3d coordinates&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_units</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">coords</span> <span class="o">==</span> <span class="s1">&#39;3d&#39;</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;Arc&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sep_units is invalid with 3d coordinates. &quot;</span>
                             <span class="s2">&quot;min_sep and max_sep should be in the same units as r (or x,y,z).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Periodic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">coords</span><span class="o">==</span><span class="s1">&#39;3d&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Periodic metric requires setting the period to use.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xperiod</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">yperiod</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">zperiod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;period options are not valid for </span><span class="si">%s</span><span class="s2"> metric.&quot;</span><span class="o">%</span><span class="n">metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coords</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Detected a change in catalog coordinate systems.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                                    <span class="s2">&quot;This probably doesn&#39;t make sense!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Detected a change in metric.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                                    <span class="s2">&quot;This probably doesn&#39;t make sense!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>  <span class="c1"># These are the regular string values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">coord_enum</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>  <span class="c1"># These are the C++-layer enums</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">metric_enum</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_zero_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># An array of all zeros with the same shape as the data arrays</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Just to make sure we get an error if we try to change it.</span>
        <span class="k">return</span> <span class="n">z</span>

    <span class="k">def</span> <span class="nf">_apply_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">:</span>
            <span class="c1"># Then we need to convert from the chord triangles to great circle triangles.</span>

            <span class="c1"># If SAS, then first fix phi.</span>
            <span class="c1"># The real spherical trig formula is:</span>
            <span class="c1"># cos(c) = cos(a) cos(b) + sin(a) sin(b) cos(phi)</span>
            <span class="c1"># Using d1 = 2 sin(c/2), d2 = 2 sin(a/2), d3 = 2 sin(b/2), this becomes:</span>
            <span class="c1"># d1^2 = d2^2 + d3^2 - 2 d2 d3 [ 1/4 d2 d3 + cos(a/2) cos(b/2) cos(phi) ]</span>
            <span class="c1"># The thing in [] is what we currently have for cos(phi).</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                <span class="n">cosphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">cosphi</span> <span class="o">-=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">cosphi</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">cosphi</span><span class="p">[</span><span class="n">cosphi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Just in case...</span>
                <span class="n">cosphi</span><span class="p">[</span><span class="n">cosphi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosphi</span><span class="p">)</span>

            <span class="c1"># Also convert the chord distance to a real angle.</span>
            <span class="c1"># L = 2 sin(theta/2)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_units</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">!=</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_sep_units</span>

    <span class="k">def</span> <span class="nf">_get_minmax_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Euclidean&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
                <span class="c1"># The minimum separation we care about is that of the smallest size, which is</span>
                <span class="c1"># min_sep * min_u.  Do the same calculation as for 2pt to get to min_size.</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv</span><span class="p">)</span>
                <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_u</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mf">3.</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>

                <span class="c1"># This time, the maximum size is d1 * b.  d1 can be as high as 2*max_sep.</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
                <span class="n">max_size</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">*</span> <span class="n">b2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
                <span class="c1"># LogSAS</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
                <span class="n">min_size1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mf">3.</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
                <span class="n">min_size2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_phi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">b2</span><span class="p">)</span>
                <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_size1</span><span class="p">,</span> <span class="n">min_size2</span><span class="p">)</span>
                <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">*</span> <span class="n">b1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LogMultipole</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_slop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
                <span class="n">min_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_sep</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>
                <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_sep</span> <span class="o">*</span> <span class="n">b1</span>
            <span class="k">return</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>

    <span class="c1"># The three-point versions of the covariance helpers.</span>
    <span class="c1"># Note: the word &quot;pairs&quot; in many of these was appropriate for 2pt, but in the 3pt case</span>
    <span class="c1"># these actually refer to triples (i,j,k).</span>

    <span class="k">def</span> <span class="nf">_get_npatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_xi_from_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">corr_only</span><span class="p">):</span>
        <span class="c1"># Compute the xi data vector for the given list of pairs.</span>
        <span class="c1"># &quot;pairs&quot; here are really triples, input as a list of (i,j,k) values.</span>

        <span class="c1"># This is the normal calculation.  It needs to be overridden when there are randoms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)],</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">],</span> <span class="n">corr_only</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_keep_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">TripleIterator</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterator</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">npatch1</span><span class="p">,</span> <span class="n">npatch2</span><span class="p">,</span> <span class="n">npatch3</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cpw</span><span class="p">,</span> <span class="n">ok</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">npatch1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">npatch2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="n">npatch3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">=</span> <span class="n">cpw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_gen</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">JackknifeTripleIterator</span><span class="p">(</span><span class="n">TripleIterator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cross_patch_weight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cpw</span><span class="si">}</span><span class="s2"> is invalid for jackknife&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># j=k=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># i=k=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="c1"># k=0</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># i=j=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="c1"># j=0</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># i=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
                    <span class="c1"># For 3pt, there are two different optimal match weights depending</span>
                    <span class="c1"># on the nature of the triangle.  If two points are in one patch, and one</span>
                    <span class="c1"># point is in another, then the same weight as MP22 is appropriate.</span>
                    <span class="c1"># For triangles where all three points are in different patches, the</span>
                    <span class="c1"># derivation is as follows:</span>
                    <span class="c1">#</span>
                    <span class="c1">#           n(n-1)(n-2)/6 DDDm - beta (n-1)(n-2)/2 DDDk</span>
                    <span class="c1"># theta_c = -------------------------------------------</span>
                    <span class="c1">#                n(n-1)(n-2)/6 - beta (n-1)(n-2)/2</span>
                    <span class="c1">#</span>
                    <span class="c1"># Then, (theta_c - &lt;theta_c&gt;)^2 comes out to</span>
                    <span class="c1">#   9 S beta^2 n (n-1) / 2 (3beta-n)^2</span>
                    <span class="c1"># As in MP22, set this equal to n S / (n-1) and solve for beta, we get</span>
                    <span class="c1"># beta = sqrt(2) n / 3 (n - 1 + sqrt(2))</span>
                    <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span>
                                <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">w2</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">w1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="c1"># 1/3 if 2 points are index, 2/3 if 1 point is index, 1 if none are index</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_jackknife_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">):</span>
        <span class="n">np</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">JackknifeTripleIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">)]</span>

    <span class="k">class</span> <span class="nc">SampleTripleIterator</span><span class="p">(</span><span class="n">TripleIterator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cross_patch_weight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cpw</span><span class="si">}</span><span class="s2"> is invalid for sample&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># j=k=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># i=k=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="c1"># k=0</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># i=j=0</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="c1"># j=0</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># i=0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">k</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sample_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">):</span>
        <span class="n">np</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SampleTripleIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">)]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">class</span> <span class="nc">MarkedTripleIterator</span><span class="p">(</span><span class="n">TripleIterator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cross_patch_weight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cpw</span><span class="si">}</span><span class="s2"> is invalid for marked_bootstrap&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">k</span> <span class="k">else</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">k</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">==</span><span class="n">i</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_marked_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MarkedTripleIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">BootstrapTripleIterator</span><span class="p">(</span><span class="n">TripleIterator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cross_patch_weight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cpw</span><span class="si">}</span><span class="s2"> is invalid for bootstrap&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ret1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">wdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ret1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">k</span> <span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">wdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="n">k</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span>
                        <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">k</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ret1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="n">wdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span><span class="o">!=</span><span class="n">k</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Like for 2pt we want to avoid getting extra copies of what are actually</span>
                <span class="c1"># auto-correlations coming from two indices equalling each other in (i,j,k).</span>
                <span class="c1"># This time, get each (i,i,i) once.</span>
                <span class="c1"># Then get (i,i,j), (i,j,i), and (j,i,i) once per each (i,j) pair with i!=j</span>
                <span class="c1"># repeated as often as they show up in the double for loop.</span>
                <span class="c1"># Finally get all triples (i,j,k) where they are all different repeated as often</span>
                <span class="c1"># as they show up in the triple for loop.</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ret1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">k</span> <span class="ow">or</span> <span class="n">j</span><span class="o">==</span><span class="n">k</span><span class="p">)</span> <span class="k">else</span> <span class="n">w1</span><span class="o">*</span><span class="n">w3</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="o">*</span><span class="n">w3</span><span class="p">))</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="o">==</span><span class="n">k</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="n">wdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">wdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="o">==</span><span class="n">k</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpw</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span>
                    <span class="n">ret2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,(</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span><span class="o">*</span><span class="n">w3</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">w2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">w3</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="o">==</span><span class="n">k</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bootstrap_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BootstrapTripleIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ok</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_cpw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">cross_patch_weight</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cross_patch_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cross_patch_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_patch_weight</span>
        <span class="k">if</span> <span class="n">cross_patch_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cross_patch_weight</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;jackknife&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Using the default cross_patch_weight=&#39;simple&#39; may be less accurate than &quot;</span>
                    <span class="s2">&quot;using cross_patch_weight=&#39;match&#39;.  See the docs for details about this &quot;</span>
                    <span class="s2">&quot;option.  It may become the new default value in a future version.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Set cross_patch_weight=&#39;simple&#39; explicitly to suppress this message.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Using the default cross_patch_weight=&#39;simple&#39; may be less accurate than &quot;</span>
                    <span class="s2">&quot;using cross_patch_weight=&#39;geom&#39;.  See the docs for details about this &quot;</span>
                    <span class="s2">&quot;option.  It may become the new default value in a future version.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Set cross_patch_weight=&#39;simple&#39; explicitly to suppress this message.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cross_patch_weight</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_write_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">make_minimal_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_valid_params</span><span class="p">)</span>
        <span class="c1"># Add in a couple other things we want to preserve that aren&#39;t construction kwargs.</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letters</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_write_col_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;u_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;v_nom&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand1&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd1&#39;</span><span class="p">,</span> <span class="s1">&#39;meand2&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd2&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanu&#39;</span><span class="p">,</span> <span class="s1">&#39;meanv&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;d3_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;phi_nom&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand1&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd1&#39;</span><span class="p">,</span> <span class="s1">&#39;meand2&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd2&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanphi&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;d3_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand1&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd1&#39;</span><span class="p">,</span> <span class="s1">&#39;meand2&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd2&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;meand3&#39;</span><span class="p">,</span> <span class="s1">&#39;meanlogd3&#39;</span><span class="p">]</span>
        <span class="n">col_names</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_class_col_names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;weightr&#39;</span><span class="p">,</span> <span class="s1">&#39;weighti&#39;</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">col_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_write_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanphi</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2nom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3nom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="p">]</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_class_data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">col</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">write_patch_results</span><span class="p">,</span> <span class="n">write_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_tot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">write_patch_results</span> <span class="ow">or</span> <span class="n">write_cov</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span>
        <span class="c1"># These helper properties define what to write for each class.</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_col_names</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_data</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_params</span>

        <span class="k">if</span> <span class="n">write_patch_results</span><span class="p">:</span>
            <span class="c1"># Note: Only include npatch1, npatch2 in serialization if we are also serializing</span>
            <span class="c1"># results.  Otherwise, the corr that is read in will behave oddly.</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;npatch1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;npatch2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;npatch3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nbins</span>
            <span class="n">num_patch_tri</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zero_tot</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">corr</span><span class="o">.</span><span class="n">_nonzero</span><span class="p">:</span>
                        <span class="n">zp_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_zp_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">zp_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">tot</span><span class="p">))</span>
                        <span class="n">num_patch_tri</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_zero_patch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_patch_tri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_patch_tri</span>
        <span class="k">if</span> <span class="n">write_cov</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cov_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">col_names</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write_patch_results</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">zero_tot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">corr</span><span class="o">.</span><span class="n">_nonzero</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">col_names</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">_write_col_names</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">_write_data</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">_write_params</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">pp_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_pp_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">col_names</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">pp_name</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_patch_tri</span>
        <span class="k">if</span> <span class="n">write_cov</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Corr3.write"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_patch_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">write_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write the correlation function to the file, file_name.</span>

<span class="sd">        For bin_type = LogRUV, the output file will include the following columns:</span>

<span class="sd">        ==========      ================================================================</span>
<span class="sd">        Column          Description</span>
<span class="sd">        ==========      ================================================================</span>
<span class="sd">        r_nom           The nominal center of the bin in r = d2 where d1 &gt; d2 &gt; d3</span>
<span class="sd">        u_nom           The nominal center of the bin in u = d3/d2</span>
<span class="sd">        v_nom           The nominal center of the bin in v = +-(d1-d2)/d3</span>
<span class="sd">        meanu           The mean value :math:`\langle u\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanv           The mean value :math:`\langle v\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        ==========      ================================================================</span>

<span class="sd">        For bin_type = LogSAS, the output file will include the following columns:</span>

<span class="sd">        ==========      ================================================================</span>
<span class="sd">        Column          Description</span>
<span class="sd">        ==========      ================================================================</span>
<span class="sd">        d2_nom          The nominal center of the bin in d2</span>
<span class="sd">        d3_nom          The nominal center of the bin in d3</span>
<span class="sd">        phi_nom         The nominal center of the bin in phi, the opening angle between</span>
<span class="sd">                        d2 and d3 in the counter-clockwise direction</span>
<span class="sd">        meanphi         The mean value :math:`\langle phi\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        ==========      ================================================================</span>

<span class="sd">        For bin_type = LogMultipole, the output file will include the following columns:</span>

<span class="sd">        ==========      ================================================================</span>
<span class="sd">        Column          Description</span>
<span class="sd">        ==========      ================================================================</span>
<span class="sd">        d2_nom          The nominal center of the bin in d2</span>
<span class="sd">        d3_nom          The nominal center of the bin in d3</span>
<span class="sd">        n               The multipole index n</span>
<span class="sd">        ==========      ================================================================</span>

<span class="sd">        In addition, all bin types include the following columns:</span>

<span class="sd">        ==========      ================================================================</span>
<span class="sd">        Column          Description</span>
<span class="sd">        ==========      ================================================================</span>
<span class="sd">        meand1          The mean value :math:`\langle d1\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd1       The mean value :math:`\langle \log(d1)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin</span>
<span class="sd">        meand2          The mean value :math:`\langle d2\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd2       The mean value :math:`\langle \log(d2)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin</span>
<span class="sd">        meand3          The mean value :math:`\langle d3\rangle` of triangles that fell</span>
<span class="sd">                        into each bin</span>
<span class="sd">        meanlogd3       The mean value :math:`\langle \log(d3)\rangle` of triangles that</span>
<span class="sd">                        fell into each bin {}</span>
<span class="sd">        weight          The total weight of triangles contributing to each bin.</span>
<span class="sd">                        (For LogMultipole, this is split into real and imaginary parts,</span>
<span class="sd">                        weightr and weighti.)</span>
<span class="sd">        ntri            The number of triangles contributing to each bin</span>
<span class="sd">        ==========      ================================================================</span>

<span class="sd">        If ``sep_units`` was given at construction, then the distances will all be in these units.</span>
<span class="sd">        Otherwise, they will be in either the same units as x,y,z (for flat or 3d coordinates) or</span>
<span class="sd">        radians (for spherical coordinates).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to write to.</span>
<span class="sd">            file_type (str):    The type of file to write (&#39;ASCII&#39; or &#39;FITS&#39;).  (default: determine</span>
<span class="sd">                                the type automatically from the extension of file_name.)</span>
<span class="sd">            precision (int):    For ASCII output catalogs, the desired precision. (default: 4;</span>
<span class="sd">                                this value can also be given in the constructor in the config dict.)</span>
<span class="sd">            write_patch_results (bool): Whether to write the patch-based results as well.</span>
<span class="sd">                                        (default: False)</span>
<span class="sd">            write_cov (bool):   Whether to write the covariance matrix as well. (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="si">}</span><span class="s1"> correlations to </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">precision</span>
        <span class="k">with</span> <span class="n">make_writer</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">write_patch_results</span><span class="p">,</span> <span class="n">write_cov</span><span class="o">=</span><span class="n">write_cov</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span> <span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">in</span> <span class="n">reader</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">num_patch_tri</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_patch_tri&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">num_zero_patch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_zero_patch&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cov_shape</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cov_shape&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span> <span class="k">if</span> <span class="n">num_patch_tri</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">max_rows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Version 5.0 used weight_re, weight_im.  These are now weightr, weighti.</span>
        <span class="c1"># Fix in place to keep backwards compatibility.</span>
        <span class="k">if</span> <span class="s1">&#39;weight_re&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_re&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_im&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">),</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># This helper function defines how to set the attributes for each class</span>
        <span class="c1"># based on what was read in.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_zero_patch</span><span class="p">):</span>
            <span class="n">zp_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_zp_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">tot</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">zp_name</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_copy</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patch_tri</span><span class="p">):</span>
            <span class="n">pp_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_pp_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">pp_name</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">max_rows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">pp_name</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">_read_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span>
        <span class="k">if</span> <span class="n">cov_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov_shape</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cov_shape</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cov_shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">cov_shape</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meand3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meand3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanlogd3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanlogd3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogRUV&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogSAS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meanu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanphi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_type</span> <span class="o">==</span> <span class="s1">&#39;LogMultipole&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weightr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weighti</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weighti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="c1"># NNN calls this DDD, rather than weight.  Let that class handle it.</span>
                <span class="c1"># But here, don&#39;t error if weight is missing.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weightr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntri</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntri&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch1</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;npatch1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch2</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;npatch2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npatch3</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;npatch3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Corr3.read"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read in values from a file.</span>

<span class="sd">        This should be a file that was written by TreeCorr, preferably a FITS or HDF5 file, so</span>
<span class="sd">        there is no loss of information.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The current object should be constructed with the same configuration parameters as</span>
<span class="sd">            the one being read.  e.g. the same min_sep, max_sep, etc.  This is not checked by</span>
<span class="sd">            the read function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to read in.</span>
<span class="sd">            file_type (str):    The type of file (&#39;ASCII&#39; or &#39;FITS&#39;).  (default: determine the type</span>
<span class="sd">                                automatically from the extension of file_name.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_letters</span><span class="si">}</span><span class="s1"> correlations from %s&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">make_reader</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Corr3.from_file"><a class="viewcode-back" href="../../correlation3.html#treecorr.Corr3.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new instance from an output file.</span>

<span class="sd">        This should be a file that was written by TreeCorr.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This classmethod may be called either using the base class or the class type that</span>
<span class="sd">            wrote the file.  E.g. if the file was written by `GGGCorrelation`, then either</span>
<span class="sd">            of the following would work and be equivalent:</span>

<span class="sd">                &gt;&gt;&gt; ggg = treecorr.GGGCorrelation.from_file(file_name)</span>
<span class="sd">                &gt;&gt;&gt; ggg = treecorr.Corr3.from_file(file_name)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):    The name of the file to read in.</span>
<span class="sd">            file_type (str):    The type of file (&#39;ASCII&#39;, &#39;FITS&#39;, or &#39;HDF&#39;).  (default: determine</span>
<span class="sd">                                the type automatically from the extension of file_name.)</span>
<span class="sd">            logger (Logger):    If desired, a logger object to use for logging. (default: None)</span>
<span class="sd">            rng (RandomState):  If desired, a numpy.random.RandomState instance to use for bootstrap</span>
<span class="sd">                                random number generation. (default: None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Correlation object, constructed from the information in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Corr3</span><span class="p">:</span>
            <span class="c1"># Then need to figure out what class to make first.</span>
            <span class="k">with</span> <span class="n">make_reader</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span> <span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">in</span> <span class="n">reader</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">letters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">letters</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_lookup_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not seem to be a valid treecorr output file.&quot;</span><span class="o">%</span><span class="n">file_name</span><span class="p">)</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_lookup_dict</span><span class="p">[</span><span class="n">letters</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Building </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cls</span><span class="si">}</span><span class="s1"> from %s&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">make_reader</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span> <span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">in</span> <span class="n">reader</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">letters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">letters</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_lookup_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not seem to be a valid treecorr output file.&quot;</span><span class="o">%</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_letters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Trying to read a </span><span class="si">%s</span><span class="s2">Correlation output file with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                              <span class="n">params</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">make_minimal_config</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Corr3</span><span class="o">.</span><span class="n">_valid_params</span><span class="p">)</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_letters</span><span class="si">}</span><span class="s1"> correlations from %s&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Mike Jarvis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>